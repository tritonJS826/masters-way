package services

import (
	"context"
	"mw-notification-bff/internal/schemas"
	pb "mw-notification-bff/pkg/grpcAutoGenerated/notification"

	"github.com/samber/lo"
)

type NotificationService struct {
	notificationGRPC        pb.NotificationClient
	enabledNotificationGRPC pb.EnabledNotificationClient
}

func NewNotificationService(
	notificationGRPC pb.NotificationClient,
	enabledNotificationGRPC pb.EnabledNotificationClient,
) *NotificationService {
	return &NotificationService{notificationGRPC, enabledNotificationGRPC}
}

func (ns *NotificationService) GetNotificationList(ctx context.Context, userUUID string) (*schemas.GetNotificationListResponse, error) {
	notificationListRaw, err := ns.notificationGRPC.GetNotificationList(ctx, &pb.GetNotificationListRequest{
		UserUuid: userUUID,
	})
	if err != nil {
		return nil, err
	}

	notificationList := lo.Map(notificationListRaw.Notifications, func(notificationRaw *pb.NotificationResponse, i int) schemas.NotificationResponse {
		return schemas.NotificationResponse{
			UUID:        notificationRaw.Uuid,
			UserUUID:    notificationRaw.UserUuid,
			IsRead:      notificationRaw.IsRead,
			Description: notificationRaw.Description,
			Url:         notificationRaw.Url,
			Nature:      notificationRaw.Nature,
			CreatedAt:   notificationRaw.CreatedAt,
		}
	})

	return &schemas.GetNotificationListResponse{
		Size:          int(notificationListRaw.Size),
		Notifications: notificationList,
	}, nil
}

func (ns *NotificationService) UpdateNotification(ctx context.Context, notificationUUID string, isRead bool) (*schemas.NotificationResponse, error) {
	notification, err := ns.notificationGRPC.UpdateNotification(ctx, &pb.UpdateNotificationRequest{
		NotificationUuid: notificationUUID,
		IsRead:           isRead,
	})
	if err != nil {
		return nil, err
	}

	return &schemas.NotificationResponse{
		UUID:        notification.Uuid,
		UserUUID:    notification.UserUuid,
		IsRead:      notification.IsRead,
		Description: notification.Description,
		Url:         notification.Url,
		Nature:      notification.Nature,
		CreatedAt:   notification.CreatedAt,
	}, nil
}

func (ns *NotificationService) GetEnabledNotificationList(ctx context.Context, userUUID string) (*schemas.GetEnabledNotificationListResponse, error) {
	enabledNotificationListRaw, err := ns.enabledNotificationGRPC.GetEnabledNotificationList(
		ctx,
		&pb.GetEnabledNotificationListRequest{
			UserUuid: userUUID,
		},
	)
	if err != nil {
		return nil, err
	}

	enabledNotificationList := lo.Map(enabledNotificationListRaw.EnabledNotifications, func(enabledNotificationRaw *pb.EnabledNotificationResponse, _ int) schemas.EnabledNotificationResponse {
		return schemas.EnabledNotificationResponse{
			UUID:      enabledNotificationRaw.Uuid,
			UserUUID:  enabledNotificationRaw.UserUuid,
			Nature:    enabledNotificationRaw.Nature,
			Channel:   enabledNotificationRaw.Channel,
			IsEnabled: enabledNotificationRaw.IsEnabled,
		}
	})

	return &schemas.GetEnabledNotificationListResponse{
		EnabledNotifications: enabledNotificationList,
	}, nil
}

func (ns *NotificationService) UpdateEnabledNotification(ctx context.Context, enabledNotificationID string, isEnabled bool) (*schemas.EnabledNotificationResponse, error) {
	in := &pb.UpdateEnabledNotificationRequest{
		EnabledNotificationUuid: enabledNotificationID,
		IsEnabled:               isEnabled,
	}
	enabledNotification, err := ns.enabledNotificationGRPC.UpdateEnabledNotification(ctx, in)
	if err != nil {
		return nil, err
	}

	return &schemas.EnabledNotificationResponse{
		UUID:      enabledNotification.Uuid,
		UserUUID:  enabledNotification.UserUuid,
		Nature:    enabledNotification.Nature,
		Channel:   enabledNotification.Channel,
		IsEnabled: enabledNotification.IsEnabled,
	}, nil
}
