package services

import (
	"context"
	openapiNotification "mw-notification-bff/apiAutogenerated/mw-notification"
	"mw-notification-bff/internal/schemas"
	notification_grpc "mw-notification/pkg/notification_v1/proto"

	"github.com/samber/lo"
)

type NotificationService struct {
	notificationAPI         *openapiNotification.APIClient
	notificationGRPC        notification_grpc.NotificationV1Client
	enabledNotificationGRPC notification_grpc.EnabledNotificationV1Client
}

func NewNotificationService(
	notificationAPI *openapiNotification.APIClient,
	notificationGRPC notification_grpc.NotificationV1Client,
	enabledNotificationGRPC notification_grpc.EnabledNotificationV1Client,
) *NotificationService {
	return &NotificationService{notificationAPI, notificationGRPC, enabledNotificationGRPC}
}

// func (ns *NotificationService) GetNotificationList(ctx context.Context) (*openapiNotification.SchemasGetNotificationListResponse, error) {
// 	notificationList, _, err := ns.notificationAPI.NotificationAPI.GetNotificationList(ctx).Execute()
// 	if err != nil {
// 		return nil, err
// 	}

// 	return notificationList, nil
// }

func (ns *NotificationService) GetNotificationListGRPC(ctx context.Context, userUUID string) (*schemas.GetNotificationListResponse, error) {
	notificationListRaw, err := ns.notificationGRPC.Get(ctx, &notification_grpc.GetNotificationListRequest{
		UserUuid: userUUID,
	})
	if err != nil {
		return nil, err
	}

	notificationList := lo.Map(notificationListRaw.Notifications, func(notificationRaw *notification_grpc.NotificationResponse, i int) schemas.NotificationResponse {
		return schemas.NotificationResponse{
			UUID:        notificationRaw.Uuid,
			UserUUID:    notificationRaw.UserUuid,
			IsRead:      notificationRaw.IsRead,
			Description: notificationRaw.Description,
			Url:         notificationRaw.Url,
			Nature:      notificationRaw.Nature,
			CreatedAt:   notificationRaw.CreatedAt,
		}
	})

	return &schemas.GetNotificationListResponse{
		Size:          int(notificationListRaw.Size),
		Notifications: notificationList,
	}, nil
}

// func (ns *NotificationService) UpdateNotification(ctx context.Context, notificationID string, isRead bool) (*openapiNotification.SchemasNotificationResponse, error) {
// 	request := openapiNotification.SchemasUpdateNotificationPayload{
// 		IsRead: isRead,
// 	}
// 	notification, _, err := ns.notificationAPI.NotificationAPI.UpdateNotification(ctx, notificationID).Request(request).Execute()
// 	if err != nil {
// 		return nil, err
// 	}

// 	return notification, nil
// }

func (ns *NotificationService) UpdateNotification(ctx context.Context, notificationUUID string, isRead bool) (*schemas.NotificationResponse, error) {
	notification, err := ns.notificationGRPC.Update(ctx, &notification_grpc.UpdateNotificationRequest{
		NotificationUuid: notificationUUID,
		IsRead:           isRead,
	})
	if err != nil {
		return nil, err
	}

	return &schemas.NotificationResponse{
		UUID:        notification.Uuid,
		UserUUID:    notification.UserUuid,
		IsRead:      notification.IsRead,
		Description: notification.Description,
		Url:         notification.Url,
		Nature:      notification.Nature,
		CreatedAt:   notification.CreatedAt,
	}, nil
}

// func (ns *NotificationService) GetEnabledNotificationList(ctx context.Context) (*openapiNotification.SchemasGetEnabledNotificationListResponse, error) {
// 	enabledNotificationList, _, err := ns.notificationAPI.EnabledNotificationAPI.GetEnabledNotificationList(ctx).Execute()
// 	if err != nil {
// 		return nil, err
// 	}

// 	return enabledNotificationList, nil
// }

func (ns *NotificationService) GetEnabledNotificationList(ctx context.Context, userUUID string) (*schemas.GetEnabledNotificationListResponse, error) {
	enabledNotificationListRaw, err := ns.enabledNotificationGRPC.Get(
		ctx,
		&notification_grpc.GetEnabledNotificationListRequest{
			UserUuid: userUUID,
		},
	)
	if err != nil {
		return nil, err
	}

	enabledNotificationList := lo.Map(enabledNotificationListRaw.EnabledNotifications, func(enabledNotificationRaw *notification_grpc.EnabledNotificationResponse, _ int) schemas.EnabledNotificationResponse {
		return schemas.EnabledNotificationResponse{
			UUID:      enabledNotificationRaw.Uuid,
			UserUUID:  enabledNotificationRaw.UserUuid,
			Nature:    enabledNotificationRaw.Nature,
			Channel:   enabledNotificationRaw.Channel,
			IsEnabled: enabledNotificationRaw.IsEnabled,
		}
	})

	return &schemas.GetEnabledNotificationListResponse{
		EnabledNotifications: enabledNotificationList,
	}, nil
}

// func (ns *NotificationService) UpdateEnabledNotification(ctx context.Context, enabledNotificationID string, isEnabled bool) (*openapiNotification.SchemasEnabledNotificationResponse, error) {
// 	request := openapiNotification.SchemasUpdateEnabledNotificationPayload{
// 		IsEnabled: isEnabled,
// 	}
// 	enabledNotification, _, err := ns.notificationAPI.EnabledNotificationAPI.UpdateEnabledNotification(ctx, enabledNotificationID).Request(request).Execute()
// 	if err != nil {
// 		return nil, err
// 	}

// 	return enabledNotification, nil
// }

func (ns *NotificationService) UpdateEnabledNotification(ctx context.Context, enabledNotificationID string, isEnabled bool) (*schemas.EnabledNotificationResponse, error) {
	in := &notification_grpc.UpdateEnabledNotificationRequest{
		EnabledNotificationUuid: enabledNotificationID,
		IsEnabled:               isEnabled,
	}
	enabledNotification, err := ns.enabledNotificationGRPC.Update(ctx, in)
	if err != nil {
		return nil, err
	}

	return &schemas.EnabledNotificationResponse{
		UUID:      enabledNotification.Uuid,
		UserUUID:  enabledNotification.UserUuid,
		Nature:    enabledNotification.Nature,
		Channel:   enabledNotification.Channel,
		IsEnabled: enabledNotification.IsEnabled,
	}, nil
}
