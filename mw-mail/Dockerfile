# Stage 1: Build base image with CA certificates                          
FROM alpine:latest AS base                                                
RUN apk add --no-cache ca-certificates libc6-compat                       
                                                                          
# Stage 2: Build application                                              
FROM golang:1.23-alpine AS build                                          
WORKDIR /app                                                              
RUN apk add --no-cache make                                               
COPY go-common ./go-common                                                
COPY mw-mail/apiAutogenerated src/apiAutogenerated/                       
COPY mw-mail/go.mod mw-mail/go.sum src/                                   
RUN cd src && go mod download                                             
COPY mw-mail src/                                                         
RUN cd src && make build                                                  
                                                                          
# Stage 3: Production                                                     
FROM base AS production # Use the base image with CA certs                
WORKDIR /app                                                              
COPY --from=build /app/src/main ./                                        
COPY --from=build /app/src/.env ./                                        
COPY --from=build /app/src/internal/db/migration ./internal/db/migration  
EXPOSE 8006                                                               
ENTRYPOINT ["./main"]