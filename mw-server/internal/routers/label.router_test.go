package routers

import (
	"context"
	openapiGeneral "mwserver/apiAutogenerated/general"
	"mwserver/internal/auth"
	"mwserver/internal/config"
	"mwserver/internal/openapi"
	"net/http"
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestCreateLabel(t *testing.T) {
	newConfig, err := config.LoadConfig("../../")
	if err != nil {
		t.Fatalf("Failed to load config: %v", err)
	}

	generalApi := openapi.MakeGeneralAPIClient(&newConfig)
	_, err = generalApi.DevAPI.DevResetDbGet(context.Background()).Execute()
	if err != nil {
		t.Fatalf("Failed to reset db: %v", err)
	}

	user := "d2cb5e1b-44df-48d3-b7a1-34f3d7a5b7e2"

	type RequestBody struct {
		Color       string
		Description string
		Name        string
		WayUuid     string
	}

	requestData := RequestBody{
		Color:       "red",
		Description: "A description",
		Name:        "Sample Name",
		WayUuid:     "9972552a-c0b3-41f3-b464-284d36a36964",
	}

	t.Run("should get all ways successfully", func(t *testing.T) {
		token, err := auth.GenerateJWT(user, newConfig.SecretSessionKey)
		if err != nil {
			t.Fatalf("Failed to generate JWT: %v", err)
		}

		ctx := context.WithValue(context.Background(), auth.ContextKeyAuthorization, "Bearer "+token)

		requestCreateLabel := openapiGeneral.SchemasCreateLabelPayload{
			Color:       requestData.Color,
			Description: requestData.Description,
			Name:        requestData.Name,
			WayUuid:     requestData.WayUuid,
		}
		Label, response, err := generalApi.LabelAPI.CreateLabel(ctx).Request(requestCreateLabel).Execute()
		if err != nil {
			t.Fatalf("Failed to create job tag: %v", err)
		}

		expectedData := &openapiGeneral.SchemasLabelResponse{
			Color:       requestData.Color,
			Description: requestData.Description,
			Name:        requestData.Name,
		}

		assert.Equal(t, http.StatusOK, response.StatusCode)
		assert.Equal(t, expectedData.Color, Label.Color)
		assert.Equal(t, expectedData.Description, Label.Description)
		assert.Equal(t, expectedData.Name, Label.Name)
	})
}
func TestUpdateLabel(t *testing.T) {
	newConfig, err := config.LoadConfig("../../")
	if err != nil {
		t.Fatalf("Failed to load config: %v", err)
	}

	generalApi := openapi.MakeGeneralAPIClient(&newConfig)
	_, err = generalApi.DevAPI.DevResetDbGet(context.Background()).Execute()
	if err != nil {
		t.Fatalf("Failed to reset db: %v", err)
	}

	user := "d2cb5e1b-44df-48d3-b7a1-34f3d7a5b7e2"

	type RequestBody struct {
		Color       string
		Description string
		Name        string
		LabelID     string
	}

	requestData := RequestBody{
		Color:       "red",
		Description: "A description",
		Name:        "Sample Name",
		LabelID:     "bf63a158-c3d9-40aa-bc0f-e6686e96de2c",
	}

	t.Run("should get all ways successfully", func(t *testing.T) {
		token, err := auth.GenerateJWT(user, newConfig.SecretSessionKey)
		if err != nil {
			t.Fatalf("Failed to generate JWT: %v", err)
		}

		ctx := context.WithValue(context.Background(), auth.ContextKeyAuthorization, "Bearer "+token)

		request := openapiGeneral.SchemasUpdateLabelPayload{
			Color:       &requestData.Color,
			Description: &requestData.Description,
			Name:        &requestData.Name,
		}
		Label, response, err := generalApi.LabelAPI.UpdateLabel(ctx, requestData.LabelID).Request(request).Execute()
		if err != nil {
			t.Fatalf("Failed to create job tag: %v", err)
		}

		expectedData := &openapiGeneral.SchemasLabelResponse{
			Color:       requestData.Color,
			Description: requestData.Description,
			Name:        requestData.Name,
		}

		assert.Equal(t, http.StatusOK, response.StatusCode)
		assert.Equal(t, expectedData.Color, Label.Color)
		assert.Equal(t, expectedData.Description, Label.Description)
		assert.Equal(t, expectedData.Name, Label.Name)
	})
}

func TestDeleteLabelById(t *testing.T) {
	newConfig, err := config.LoadConfig("../../")
	if err != nil {
		t.Fatalf("Failed to load config: %v", err)
	}

	generalApi := openapi.MakeGeneralAPIClient(&newConfig)
	_, err = generalApi.DevAPI.DevResetDbGet(context.Background()).Execute()
	if err != nil {
		t.Fatalf("Failed to reset db: %v", err)
	}

	user := "d2cb5e1b-44df-48d3-b7a1-34f3d7a5b7e2"
	labelID := "d569aa06-452c-4602-a788-2ffca4c959a8"
	wayID := "32cb5e1b-44df-48d3-b7a1-34f3d7a5b7e2"

	t.Run("should get all ways successfully", func(t *testing.T) {
		token, err := auth.GenerateJWT(user, newConfig.SecretSessionKey)
		if err != nil {
			t.Fatalf("Failed to generate JWT: %v", err)
		}

		ctx := context.WithValue(context.Background(), auth.ContextKeyAuthorization, "Bearer "+token)
		response, err := generalApi.LabelAPI.DeleteLabel(ctx, labelID).Execute()
		if err != nil {
			t.Fatalf("Failed to delete job tag: %v", err)
		}

		assert.Equal(t, http.StatusNoContent, response.StatusCode)

		report, response, err := generalApi.DayReportAPI.GetDayReports(ctx, wayID).Execute()
		if err != nil {
			t.Fatalf("Failed to get report: %v", err)
		}

		isLabelExists := false
		for _, dayReport := range report.DayReports {
			for _, jobDone := range dayReport.JobsDone {
				for _, tag := range jobDone.Tags {
					if tag.Uuid == labelID {
						isLabelExists = true
						break
					}
				}
			}
		}

		if isLabelExists {
			t.Fatalf("Found job tag: %v", labelID)
		}
	})
}
