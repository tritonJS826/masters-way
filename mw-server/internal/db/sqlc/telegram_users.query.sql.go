// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: telegram_users.query.sql

package db

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const cleanupExpiredTelegramCodes = `-- name: CleanupExpiredTelegramCodes :exec
DELETE FROM telegram_users
WHERE status = 'initiated' AND auth_code_expires_at < CURRENT_TIMESTAMP
`

func (q *Queries) CleanupExpiredTelegramCodes(ctx context.Context) error {
	_, err := q.db.Exec(ctx, cleanupExpiredTelegramCodes)
	return err
}

const createPendingTelegramUser = `-- name: CreatePendingTelegramUser :one
INSERT INTO telegram_users (
    telegram_id,
    user_uuid,
    telegram_name,
    auth_code,
    auth_code_expires_at,
    status
) VALUES (
    $1, NULL, $2, $3, $4, 'initiated'
) RETURNING telegram_id, user_uuid, telegram_name, auth_code, auth_code_expires_at, status, created_at, updated_at
`

type CreatePendingTelegramUserParams struct {
	TelegramID        int64            `json:"telegram_id"`
	TelegramName      pgtype.Text      `json:"telegram_name"`
	AuthCode          string           `json:"auth_code"`
	AuthCodeExpiresAt pgtype.Timestamp `json:"auth_code_expires_at"`
}

func (q *Queries) CreatePendingTelegramUser(ctx context.Context, arg CreatePendingTelegramUserParams) (TelegramUser, error) {
	row := q.db.QueryRow(ctx, createPendingTelegramUser,
		arg.TelegramID,
		arg.TelegramName,
		arg.AuthCode,
		arg.AuthCodeExpiresAt,
	)
	var i TelegramUser
	err := row.Scan(
		&i.TelegramID,
		&i.UserUuid,
		&i.TelegramName,
		&i.AuthCode,
		&i.AuthCodeExpiresAt,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const deleteTelegramUserByAuthCode = `-- name: DeleteTelegramUserByAuthCode :exec
DELETE FROM telegram_users
WHERE auth_code = $1
`

func (q *Queries) DeleteTelegramUserByAuthCode(ctx context.Context, authCode string) error {
	_, err := q.db.Exec(ctx, deleteTelegramUserByAuthCode, authCode)
	return err
}

const deleteTelegramUserByTelegramId = `-- name: DeleteTelegramUserByTelegramId :exec
DELETE FROM telegram_users
WHERE telegram_id = $1
`

func (q *Queries) DeleteTelegramUserByTelegramId(ctx context.Context, telegramID int64) error {
	_, err := q.db.Exec(ctx, deleteTelegramUserByTelegramId, telegramID)
	return err
}

const getLinkedUserByTelegramId = `-- name: GetLinkedUserByTelegramId :one
SELECT tu.telegram_id, tu.user_uuid, tu.telegram_name, tu.auth_code, tu.auth_code_expires_at, tu.status, tu.created_at, tu.updated_at, u.email, u.name as user_name, u.image_url as user_image
FROM telegram_users tu
LEFT JOIN users u ON tu.user_uuid = u.uuid
WHERE tu.telegram_id = $1
  AND tu.status = 'linked'
  AND tu.user_uuid IS NOT NULL
`

type GetLinkedUserByTelegramIdRow struct {
	TelegramID        int64            `json:"telegram_id"`
	UserUuid          pgtype.UUID      `json:"user_uuid"`
	TelegramName      pgtype.Text      `json:"telegram_name"`
	AuthCode          string           `json:"auth_code"`
	AuthCodeExpiresAt pgtype.Timestamp `json:"auth_code_expires_at"`
	Status            string           `json:"status"`
	CreatedAt         pgtype.Timestamp `json:"created_at"`
	UpdatedAt         pgtype.Timestamp `json:"updated_at"`
	Email             pgtype.Text      `json:"email"`
	UserName          pgtype.Text      `json:"user_name"`
	UserImage         pgtype.Text      `json:"user_image"`
}

func (q *Queries) GetLinkedUserByTelegramId(ctx context.Context, telegramID int64) (GetLinkedUserByTelegramIdRow, error) {
	row := q.db.QueryRow(ctx, getLinkedUserByTelegramId, telegramID)
	var i GetLinkedUserByTelegramIdRow
	err := row.Scan(
		&i.TelegramID,
		&i.UserUuid,
		&i.TelegramName,
		&i.AuthCode,
		&i.AuthCodeExpiresAt,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.Email,
		&i.UserName,
		&i.UserImage,
	)
	return i, err
}

const getPendingTelegramUserByAuthCode = `-- name: GetPendingTelegramUserByAuthCode :one
SELECT telegram_id, user_uuid, telegram_name, auth_code, auth_code_expires_at, status, created_at, updated_at FROM telegram_users
WHERE auth_code = $1
  AND status = 'initiated'
  AND auth_code_expires_at > CURRENT_TIMESTAMP
`

func (q *Queries) GetPendingTelegramUserByAuthCode(ctx context.Context, authCode string) (TelegramUser, error) {
	row := q.db.QueryRow(ctx, getPendingTelegramUserByAuthCode, authCode)
	var i TelegramUser
	err := row.Scan(
		&i.TelegramID,
		&i.UserUuid,
		&i.TelegramName,
		&i.AuthCode,
		&i.AuthCodeExpiresAt,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getTelegramUserByAuthCode = `-- name: GetTelegramUserByAuthCode :one
SELECT telegram_id, user_uuid, telegram_name, auth_code, auth_code_expires_at, status, created_at, updated_at FROM telegram_users
WHERE auth_code = $1
  AND auth_code_expires_at > CURRENT_TIMESTAMP
`

func (q *Queries) GetTelegramUserByAuthCode(ctx context.Context, authCode string) (TelegramUser, error) {
	row := q.db.QueryRow(ctx, getTelegramUserByAuthCode, authCode)
	var i TelegramUser
	err := row.Scan(
		&i.TelegramID,
		&i.UserUuid,
		&i.TelegramName,
		&i.AuthCode,
		&i.AuthCodeExpiresAt,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getTelegramUserByTelegramId = `-- name: GetTelegramUserByTelegramId :one
SELECT telegram_id, user_uuid, telegram_name, auth_code, auth_code_expires_at, status, created_at, updated_at FROM telegram_users
WHERE telegram_id = $1
`

func (q *Queries) GetTelegramUserByTelegramId(ctx context.Context, telegramID int64) (TelegramUser, error) {
	row := q.db.QueryRow(ctx, getTelegramUserByTelegramId, telegramID)
	var i TelegramUser
	err := row.Scan(
		&i.TelegramID,
		&i.UserUuid,
		&i.TelegramName,
		&i.AuthCode,
		&i.AuthCodeExpiresAt,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const linkTelegramUser = `-- name: LinkTelegramUser :exec
INSERT INTO telegram_users (
    telegram_id,
    user_uuid,
    telegram_name,
    auth_code,
    auth_code_expires_at,
    status
) VALUES (
    $1, $2, $3, $4, CURRENT_TIMESTAMP + INTERVAL '10 minutes', 'linked'
)
ON CONFLICT (telegram_id) DO UPDATE SET
    user_uuid = EXCLUDED.user_uuid,
    telegram_name = COALESCE(EXCLUDED.telegram_name, telegram_users.telegram_name),
    auth_code = EXCLUDED.auth_code,
    auth_code_expires_at = EXCLUDED.auth_code_expires_at,
    status = EXCLUDED.status,
    updated_at = CURRENT_TIMESTAMP
`

type LinkTelegramUserParams struct {
	TelegramID   int64       `json:"telegram_id"`
	UserUuid     pgtype.UUID `json:"user_uuid"`
	TelegramName pgtype.Text `json:"telegram_name"`
	AuthCode     string      `json:"auth_code"`
}

func (q *Queries) LinkTelegramUser(ctx context.Context, arg LinkTelegramUserParams) error {
	_, err := q.db.Exec(ctx, linkTelegramUser,
		arg.TelegramID,
		arg.UserUuid,
		arg.TelegramName,
		arg.AuthCode,
	)
	return err
}

const linkTelegramUserByAuthCode = `-- name: LinkTelegramUserByAuthCode :exec
UPDATE telegram_users SET
    user_uuid = $1,
    status = 'linked',
    auth_code_expires_at = CURRENT_TIMESTAMP,
    updated_at = CURRENT_TIMESTAMP
WHERE auth_code = $2
  AND status = 'initiated'
  AND auth_code_expires_at > CURRENT_TIMESTAMP
`

type LinkTelegramUserByAuthCodeParams struct {
	UserUuid pgtype.UUID `json:"user_uuid"`
	AuthCode string      `json:"auth_code"`
}

func (q *Queries) LinkTelegramUserByAuthCode(ctx context.Context, arg LinkTelegramUserByAuthCodeParams) error {
	_, err := q.db.Exec(ctx, linkTelegramUserByAuthCode, arg.UserUuid, arg.AuthCode)
	return err
}
