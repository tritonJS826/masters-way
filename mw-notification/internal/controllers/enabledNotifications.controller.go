package controllers

import (
	"context"
	"mw-notification/internal/schemas"
	"mw-notification/internal/services"
	pb "mw-notification/pkg/grpcAutoGenerated/notification"

	"github.com/google/uuid"
	"github.com/samber/lo"
	"google.golang.org/protobuf/types/known/emptypb"
)

type EnabledNotificationController struct {
	enabledNotificationService *services.EnabledNotificationService
	pb.UnimplementedEnabledNotificationServer
}

func NewEnabledNotificationController(enabledNotificationService *services.EnabledNotificationService) *EnabledNotificationController {
	return &EnabledNotificationController{enabledNotificationService: enabledNotificationService}
}

func (ec *EnabledNotificationController) CreateEnabledNotifications(ctx context.Context, in *pb.CreateEnabledNotificationsRequest) (*emptypb.Empty, error) {
	err := ec.enabledNotificationService.CreateEnabledNotifications(ctx, uuid.MustParse(in.GetUserUuid()))
	if err != nil {
		return nil, err
	}

	return &emptypb.Empty{}, nil
}

func (ec *EnabledNotificationController) UpdateEnabledNotification(ctx context.Context, in *pb.UpdateEnabledNotificationRequest) (*pb.EnabledNotificationResponse, error) {
	enabledNotification, err := ec.enabledNotificationService.UpdateEnabledNotification(ctx, &services.UpdateEnabledNotificationParams{
		EnabledNotificationUUID: uuid.MustParse(in.GetEnabledNotificationUuid()),
		IsEnabled:               in.GetIsEnabled(),
	})
	if err != nil {
		return nil, err
	}

	return &pb.EnabledNotificationResponse{
		Uuid:      enabledNotification.UUID,
		UserUuid:  enabledNotification.UserUUID,
		Nature:    enabledNotification.Nature,
		Channel:   enabledNotification.Channel,
		IsEnabled: enabledNotification.IsEnabled,
	}, nil
}

func (ec *EnabledNotificationController) GetEnabledNotificationList(ctx context.Context, in *pb.GetEnabledNotificationListRequest) (*pb.GetEnabledNotificationListResponse, error) {
	getEnabledNotificationListRaw, err := ec.enabledNotificationService.GetEnabledNotificationListByUserID(ctx, uuid.MustParse(in.GetUserUuid()))
	if err != nil {
		return nil, err
	}

	notifications := lo.Map(getEnabledNotificationListRaw.EnabledNotifications, func(notificationRaw schemas.EnabledNotificationResponse, _ int) *pb.EnabledNotificationResponse {
		return &pb.EnabledNotificationResponse{
			Uuid:      notificationRaw.UUID,
			UserUuid:  notificationRaw.UserUUID,
			Nature:    notificationRaw.Nature,
			Channel:   notificationRaw.Channel,
			IsEnabled: notificationRaw.IsEnabled,
		}
	})

	return &pb.GetEnabledNotificationListResponse{
		EnabledNotifications: notifications,
	}, nil
}
