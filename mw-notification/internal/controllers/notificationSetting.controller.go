package controllers

import (
	"context"
	"mw-notification/internal/schemas"
	"mw-notification/internal/services"
	pb "mw-notification/pkg/grpcAutoGenerated/notification"

	"github.com/google/uuid"
	"github.com/samber/lo"
	"google.golang.org/protobuf/types/known/emptypb"
)

type NotificationSettingController struct {
	notificationSettingService *services.NotificationSettingService
	pb.UnimplementedNotificationSettingServiceServer
}

func NewNotificationSettingController(notificationSettingService *services.NotificationSettingService) *NotificationSettingController {
	return &NotificationSettingController{notificationSettingService: notificationSettingService}
}

func (ec *NotificationSettingController) CreateNotificationSettings(ctx context.Context, in *pb.CreateNotificationSettingsRequest) (*emptypb.Empty, error) {
	err := ec.notificationSettingService.CreateNotificationSettings(ctx, uuid.MustParse(in.GetUserUuid()))
	if err != nil {
		return nil, err
	}

	return &emptypb.Empty{}, nil
}

func (ec *NotificationSettingController) UpdateNotificationSetting(ctx context.Context, in *pb.UpdateNotificationSettingRequest) (*pb.NotificationSettingResponse, error) {
	notificationSetting, err := ec.notificationSettingService.UpdateNotificationSetting(ctx, &services.UpdateNotificationSettingParams{
		NotificationSettingUUID: uuid.MustParse(in.GetNotificationSettingUuid()),
		IsEnabled:               in.GetIsEnabled(),
	})
	if err != nil {
		return nil, err
	}

	return &pb.NotificationSettingResponse{
		Uuid:      notificationSetting.UUID,
		UserUuid:  notificationSetting.UserUUID,
		Nature:    pb.Nature(pb.Nature_value[notificationSetting.Nature]),
		Channel:   notificationSetting.Channel,
		IsEnabled: notificationSetting.IsEnabled,
	}, nil
}

func (ec *NotificationSettingController) GetNotificationSettingList(ctx context.Context, in *pb.GetNotificationSettingListRequest) (*pb.GetNotificationSettingListResponse, error) {
	getNotificationSettingListRaw, err := ec.notificationSettingService.GetNotificationSettingListByUserID(ctx, uuid.MustParse(in.GetUserUuid()))
	if err != nil {
		return nil, err
	}

	notificationSettings := lo.Map(getNotificationSettingListRaw.NotificationSettings, func(notificationSettingRaw schemas.NotificationSettingResponse, _ int) *pb.NotificationSettingResponse {
		return &pb.NotificationSettingResponse{
			Uuid:      notificationSettingRaw.UUID,
			UserUuid:  notificationSettingRaw.UserUUID,
			Nature:    pb.Nature(pb.Nature_value[notificationSettingRaw.Nature]),
			Channel:   notificationSettingRaw.Channel,
			IsEnabled: notificationSettingRaw.IsEnabled,
		}
	})

	return &pb.GetNotificationSettingListResponse{
		NotificationSettings: notificationSettings,
	}, nil
}
