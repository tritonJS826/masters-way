package controllers

import (
	"context"
	"mw-notification/internal/schemas"
	"mw-notification/internal/services"
	pb "mw-notification/pkg/grpcAutoGenerated/notification"

	"github.com/google/uuid"
	"github.com/samber/lo"
)

type NotificationController struct {
	notificationService *services.NotificationService
	pb.UnimplementedNotificationServer
}

func NewNotificationController(notificationService *services.NotificationService) *NotificationController {
	return &NotificationController{notificationService: notificationService}
}

func (nc *NotificationController) CreateNotification(ctx context.Context, in *pb.CreateNotificationRequest) (*pb.NotificationResponse, error) {
	params := &services.CreateNotificationParams{
		UserID:      uuid.MustParse(in.GetUserUuid()),
		Description: in.Description,
		Url:         in.Url,
		Nature:      in.Nature.String(),
	}
	notification, err := nc.notificationService.CreateNotification(ctx, params)
	if err != nil {
		return nil, err
	}

	return &pb.NotificationResponse{
		Uuid:        notification.UUID,
		UserUuid:    notification.UserUUID,
		IsRead:      notification.IsRead,
		Description: notification.Description,
		Url:         notification.Url,
		Nature:      pb.Nature(pb.Nature_value[notification.Nature]),
		CreatedAt:   notification.CreatedAt,
	}, nil
}

func (nc *NotificationController) UpdateNotification(ctx context.Context, in *pb.UpdateNotificationRequest) (*pb.NotificationResponse, error) {
	notification, err := nc.notificationService.UpdateNotification(ctx, &services.UpdateNotificationParams{
		NotificationID: uuid.MustParse(in.GetNotificationUuid()),
		IsRead:         in.GetIsRead(),
	})
	if err != nil {
		return nil, err
	}

	return &pb.NotificationResponse{
		Uuid:        notification.UUID,
		UserUuid:    notification.UserUUID,
		IsRead:      notification.IsRead,
		Description: notification.Description,
		Url:         notification.Url,
		Nature:      pb.Nature(pb.Nature_value[notification.Nature]),
		CreatedAt:   notification.CreatedAt,
	}, nil
}

func (nc *NotificationController) GetNotificationList(ctx context.Context, in *pb.GetNotificationListRequest) (*pb.GetNotificationListResponse, error) {
	getNotificationResponseRaw, err := nc.notificationService.GetNotificationListByUserID(ctx, uuid.MustParse(in.GetUserUuid()))
	if err != nil {
		return nil, err
	}

	notifications := lo.Map(getNotificationResponseRaw.Notifications, func(notificationRaw schemas.NotificationResponse, _ int) *pb.NotificationResponse {
		return &pb.NotificationResponse{
			Uuid:        notificationRaw.UUID,
			UserUuid:    notificationRaw.UserUUID,
			IsRead:      notificationRaw.IsRead,
			Description: notificationRaw.Description,
			Url:         notificationRaw.Url,
			Nature:      pb.Nature(pb.Nature_value[notificationRaw.Nature]),
			CreatedAt:   notificationRaw.CreatedAt,
		}
	})

	return &pb.GetNotificationListResponse{
		Size:          int32(getNotificationResponseRaw.Size),
		Notifications: notifications,
	}, nil
}
