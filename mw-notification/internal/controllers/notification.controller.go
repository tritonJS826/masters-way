package controllers

import (
	"context"
	"mw-notification/internal/schemas"
	"mw-notification/internal/services"
	pb "mw-notification/pkg/grpcAutoGenerated/notification"

	"github.com/google/uuid"
	"github.com/samber/lo"
)

type NotificationController struct {
	notificationService        *services.NotificationService
	notificationSettingService *services.NotificationSettingService
	pb.UnimplementedNotificationServiceServer
}

func NewNotificationController(
	notificationService *services.NotificationService,
	notificationSettingService *services.NotificationSettingService,
) *NotificationController {
	return &NotificationController{
		notificationService:        notificationService,
		notificationSettingService: notificationSettingService,
	}
}

func (nc *NotificationController) CreateNotifications(ctx context.Context, in *pb.CreateNotificationRequest) (*pb.CreateNotificationsResponse, error) {
	userUUIDs := in.GetUserUuids()
	createNotificationList := make([]*pb.CreateNotificationResponse, 0, len(userUUIDs))
	for _, userUUID := range userUUIDs {
		params := &services.CreateNotificationParams{
			UserID:      uuid.MustParse(userUUID),
			Description: in.Description,
			Url:         in.Url,
			Nature:      in.Nature.String(),
		}
		notificationRaw, err := nc.notificationService.CreateNotification(ctx, params)
		if err != nil {
			return nil, err
		}

		notification := &pb.Notification{
			Uuid:        notificationRaw.UUID,
			UserUuid:    notificationRaw.UserUUID,
			IsRead:      notificationRaw.IsRead,
			Description: notificationRaw.Description,
			Url:         notificationRaw.Url,
			Nature:      pb.Nature(pb.Nature_value[notificationRaw.Nature]),
			CreatedAt:   notificationRaw.CreatedAt,
		}

		enabledNotificationSettingList, err := nc.notificationSettingService.GetEnabledNotificationSettingListByUserID(ctx, uuid.MustParse(userUUID))
		if err != nil {
			return nil, err
		}
		notificationSettingList := lo.Map(enabledNotificationSettingList.NotificationSettings, func(enabledNotificationSetting schemas.NotificationSettingResponse, _ int) *pb.NotificationSettingResponse {
			return &pb.NotificationSettingResponse{
				Uuid:      enabledNotificationSetting.UUID,
				UserUuid:  enabledNotificationSetting.UserUUID,
				Nature:    pb.Nature(pb.Nature_value[notificationRaw.Nature]),
				Channel:   enabledNotificationSetting.Channel,
				IsEnabled: enabledNotificationSetting.IsEnabled,
			}
		})

		createNotificationList = append(createNotificationList, &pb.CreateNotificationResponse{
			Notification:            notification,
			NotificationSettingList: notificationSettingList,
		})
	}

	return &pb.CreateNotificationsResponse{
		CreateNotificationList: createNotificationList,
	}, nil
}

func (nc *NotificationController) UpdateNotification(ctx context.Context, in *pb.UpdateNotificationRequest) (*pb.Notification, error) {
	notification, err := nc.notificationService.UpdateNotification(ctx, &services.UpdateNotificationParams{
		NotificationID: uuid.MustParse(in.GetNotificationUuid()),
		IsRead:         in.GetIsRead(),
	})
	if err != nil {
		return nil, err
	}

	return &pb.Notification{
		Uuid:        notification.UUID,
		UserUuid:    notification.UserUUID,
		IsRead:      notification.IsRead,
		Description: notification.Description,
		Url:         notification.Url,
		Nature:      pb.Nature(pb.Nature_value[notification.Nature]),
		CreatedAt:   notification.CreatedAt,
	}, nil
}

func (nc *NotificationController) GetNotificationList(ctx context.Context, in *pb.GetNotificationListRequest) (*pb.GetNotificationListResponse, error) {
	getNotificationListByUserIDParams := &services.GetNotificationListByUserIDParams{
		UserID:    uuid.MustParse(in.GetUserUuid()),
		Page:      in.GetPage(),
		Limit:     in.GetLimit(),
		IsOnlyNew: in.GetIsOnlyNew(),
	}
	getNotificationResponseRaw, err := nc.notificationService.GetNotificationListByUserID(ctx, getNotificationListByUserIDParams)
	if err != nil {
		return nil, err
	}

	notifications := lo.Map(getNotificationResponseRaw.Notifications, func(notificationRaw schemas.NotificationResponse, _ int) *pb.Notification {
		return &pb.Notification{
			Uuid:        notificationRaw.UUID,
			UserUuid:    notificationRaw.UserUUID,
			IsRead:      notificationRaw.IsRead,
			Description: notificationRaw.Description,
			Url:         notificationRaw.Url,
			Nature:      pb.Nature(pb.Nature_value[notificationRaw.Nature]),
			CreatedAt:   notificationRaw.CreatedAt,
		}
	})

	return &pb.GetNotificationListResponse{
		Size:          int32(getNotificationResponseRaw.Size),
		Notifications: notifications,
	}, nil
}
