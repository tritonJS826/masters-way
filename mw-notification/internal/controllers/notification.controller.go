package controllers

import (
	"context"
	"fmt"
	webapprouter "go-common/webappRouter"

	"mw-notification/internal/config"
	"mw-notification/internal/schemas"
	"mw-notification/internal/services"
	pb "mw-notification/pkg/grpcAutoGenerated/notification"

	"github.com/google/uuid"
	"github.com/samber/lo"
)

type NotificationController struct {
	notificationService        *services.NotificationService
	notificationSettingService *services.NotificationSettingService
	config                     *config.Config
	pb.UnimplementedNotificationServiceServer
}

func NewNotificationController(
	notificationService *services.NotificationService,
	notificationSettingService *services.NotificationSettingService,
	config *config.Config,
) *NotificationController {
	return &NotificationController{
		notificationService:        notificationService,
		notificationSettingService: notificationSettingService,
		config:                     config,
	}
}

func (nc *NotificationController) CreateNotifications(ctx context.Context, in *pb.CreateNotificationRequest) (*pb.CreateNotificationsResponse, error) {
	receivers := in.GetReceivers()
	nature := in.GetNature()

	createNotificationList := make([]*pb.NotificationWithSettings, 0, len(receivers))
	for _, receiver := range receivers {
		var params *services.CreateNotificationParams
		switch nature.String() {
		case pb.Nature_mentoring_way.Enum().String():
			fmt.Println("Nature_mentoring_way")
			params = &services.CreateNotificationParams{
				UserID:      uuid.MustParse(receiver.UserUuid),
				Description: receiver.GetMentoringWayData().WayName,
				Nature:      nature.String(),
				Url:         webapprouter.NewWebappRouter(nc.config.WebappBaseURL).GetWayPage(receiver.GetMentoringWayData().WayId),
			}
		case pb.Nature_own_way.Enum().String():
			fmt.Println("Nature_own_way")
			params = &services.CreateNotificationParams{
				UserID:      uuid.MustParse(receiver.UserUuid),
				Description: receiver.GetOwnWayData().WayName,
				Nature:      nature.String(),
				Url:         webapprouter.NewWebappRouter(nc.config.WebappBaseURL).GetWayPage(receiver.GetOwnWayData().WayId),
			}
		default:
			fmt.Printf("Nature not implemented: %s", nature.String())
		}
		notificationRaw, err := nc.notificationService.CreateNotification(ctx, params)
		if err != nil {
			return nil, err
		}

		notification := &pb.Notification{
			Uuid:        notificationRaw.UUID,
			UserUuid:    notificationRaw.UserUUID,
			IsRead:      notificationRaw.IsRead,
			Description: notificationRaw.Description,
			Url:         notificationRaw.Url,
			Nature:      pb.Nature(pb.Nature_value[notificationRaw.Nature]),
			CreatedAt:   notificationRaw.CreatedAt,
		}

		enabledNotificationSettingList, err := nc.notificationSettingService.GetEnabledNotificationSettingListByUserID(ctx, params.UserID)
		if err != nil {
			return nil, err
		}
		notificationSettingList := lo.Map(enabledNotificationSettingList.NotificationSettings, func(enabledNotificationSetting schemas.NotificationSettingResponse, _ int) *pb.NotificationSettingResponse {
			return &pb.NotificationSettingResponse{
				Uuid:      enabledNotificationSetting.UUID,
				UserUuid:  enabledNotificationSetting.UserUUID,
				Nature:    pb.Nature(pb.Nature_value[enabledNotificationSetting.Nature]),
				Channel:   pb.Channel(pb.Channel_value[enabledNotificationSetting.Channel]),
				IsEnabled: enabledNotificationSetting.IsEnabled,
			}
		})

		createNotificationList = append(createNotificationList, &pb.NotificationWithSettings{
			Notification:            notification,
			NotificationSettingList: notificationSettingList,
		})
	}

	return &pb.CreateNotificationsResponse{
		NotificationWithSettingsList: createNotificationList,
	}, nil
}

func (nc *NotificationController) UpdateNotification(ctx context.Context, in *pb.UpdateNotificationRequest) (*pb.Notification, error) {
	notification, err := nc.notificationService.UpdateNotification(ctx, &services.UpdateNotificationParams{
		NotificationID: uuid.MustParse(in.GetNotificationUuid()),
		IsRead:         in.GetIsRead(),
	})
	if err != nil {
		return nil, err
	}

	return &pb.Notification{
		Uuid:        notification.UUID,
		UserUuid:    notification.UserUUID,
		IsRead:      notification.IsRead,
		Description: notification.Description,
		Url:         notification.Url,
		Nature:      pb.Nature(pb.Nature_value[notification.Nature]),
		CreatedAt:   notification.CreatedAt,
	}, nil
}

func (nc *NotificationController) GetNotificationList(ctx context.Context, in *pb.GetNotificationListRequest) (*pb.GetNotificationListResponse, error) {
	getNotificationListByUserIDParams := &services.GetNotificationListByUserIDParams{
		UserID:    uuid.MustParse(in.GetUserUuid()),
		Page:      in.GetPage(),
		Limit:     in.GetLimit(),
		IsOnlyNew: in.GetIsOnlyNew(),
	}
	getNotificationResponseRaw, err := nc.notificationService.GetNotificationListByUserID(ctx, getNotificationListByUserIDParams)
	if err != nil {
		return nil, err
	}

	notifications := lo.Map(getNotificationResponseRaw.Notifications, func(notificationRaw schemas.NotificationResponse, _ int) *pb.Notification {
		return &pb.Notification{
			Uuid:        notificationRaw.UUID,
			UserUuid:    notificationRaw.UserUUID,
			IsRead:      notificationRaw.IsRead,
			Description: notificationRaw.Description,
			Url:         notificationRaw.Url,
			Nature:      pb.Nature(pb.Nature_value[notificationRaw.Nature]),
			CreatedAt:   notificationRaw.CreatedAt,
		}
	})

	return &pb.GetNotificationListResponse{
		UnreadSize:    int32(getNotificationResponseRaw.UnreadSize),
		TotalSize:     int32(getNotificationResponseRaw.TotalSize),
		Notifications: notifications,
	}, nil
}
