package services

import (
	"context"
	db "mw-training/internal/db/sqlc"
	pb "mw-training/pkg/grpcAutogenerated/training"
	"mw-training/pkg/utils"

	"github.com/jackc/pgx/v5"
	"github.com/jackc/pgx/v5/pgtype"
	"github.com/jackc/pgx/v5/pgxpool"
)

type PracticeMaterialRepository interface {
	CreatePracticeMaterialInTopic(ctx context.Context, params db.CreatePracticeMaterialInTopicParams) (db.PracticeMaterial, error)
	UpdatePracticeMaterial(ctx context.Context, params db.UpdatePracticeMaterialParams) (db.PracticeMaterial, error)
	DeletePracticeMaterial(ctx context.Context, practiceMaterialUuid pgtype.UUID) (db.PracticeMaterial, error)
	WithTx(tx pgx.Tx) *db.Queries
}

type PracticeMaterialService struct {
	practiceMaterialRepository PracticeMaterialRepository
	pgxPool                    *pgxpool.Pool
}

func NewPracticeMaterialService(pgxPool *pgxpool.Pool, practiceMaterialRepository PracticeMaterialRepository) *PracticeMaterialService {
	return &PracticeMaterialService{
		pgxPool:                    pgxPool,
		practiceMaterialRepository: practiceMaterialRepository,
	}
}

func (pms *PracticeMaterialService) CreatePracticeMaterial(ctx context.Context, params db.CreatePracticeMaterialInTopicParams) (*pb.PracticeMaterial, error) {
	practiceMaterialDb, err := pms.practiceMaterialRepository.CreatePracticeMaterialInTopic(ctx, params)
	if err != nil {
		return &pb.PracticeMaterial{}, nil
	}
	practiceMaterial := &pb.PracticeMaterial{
		Uuid:         *utils.MarshalPgUUID(practiceMaterialDb.Uuid),
		TopicUuid:    *utils.MarshalPgUUID(practiceMaterialDb.TopicUuid),
		Name:         practiceMaterialDb.Name.String,
		Order:        practiceMaterialDb.PracticeMaterialOrder,
		Description:  practiceMaterialDb.TaskDescription.String,
		Answer:       practiceMaterialDb.Answer.String,
		PracticeType: string(practiceMaterialDb.PracticeType),
		TimeToAnswer: practiceMaterialDb.TimeToAnswer,
		CreatedAt:    *utils.MarshalPgTimestamp(practiceMaterialDb.CreatedAt),
		UpdatedAt:    *utils.MarshalPgTimestamp(practiceMaterialDb.UpdatedAt),
	}
	return practiceMaterial, nil
}

func (pms *PracticeMaterialService) UpdatePracticeMaterial(ctx context.Context, params db.UpdatePracticeMaterialParams) (*pb.PracticeMaterial, error) {
	practiceMaterialDb, err := pms.practiceMaterialRepository.UpdatePracticeMaterial(ctx, params)
	if err != nil {
		return &pb.PracticeMaterial{}, nil
	}
	practiceMaterial := &pb.PracticeMaterial{
		Uuid:         *utils.MarshalPgUUID(practiceMaterialDb.Uuid),
		TopicUuid:    *utils.MarshalPgUUID(practiceMaterialDb.TopicUuid),
		Name:         practiceMaterialDb.Name.String,
		Order:        practiceMaterialDb.PracticeMaterialOrder,
		Description:  practiceMaterialDb.TaskDescription.String,
		Answer:       practiceMaterialDb.Answer.String,
		PracticeType: string(practiceMaterialDb.PracticeType),
		TimeToAnswer: practiceMaterialDb.TimeToAnswer,
		CreatedAt:    *utils.MarshalPgTimestamp(practiceMaterialDb.CreatedAt),
		UpdatedAt:    *utils.MarshalPgTimestamp(practiceMaterialDb.UpdatedAt),
	}
	return practiceMaterial, nil
}

func (pms *PracticeMaterialService) DeletePracticeMaterial(ctx context.Context, practiceMaterialUuid pgtype.UUID) (*pb.PracticeMaterial, error) {
	practiceMaterialDb, err := pms.practiceMaterialRepository.DeletePracticeMaterial(ctx, practiceMaterialUuid)
	if err != nil {
		return &pb.PracticeMaterial{}, nil
	}
	practiceMaterial := &pb.PracticeMaterial{
		Uuid:         *utils.MarshalPgUUID(practiceMaterialDb.Uuid),
		TopicUuid:    *utils.MarshalPgUUID(practiceMaterialDb.TopicUuid),
		Name:         practiceMaterialDb.Name.String,
		Order:        practiceMaterialDb.PracticeMaterialOrder,
		Description:  practiceMaterialDb.TaskDescription.String,
		Answer:       practiceMaterialDb.Answer.String,
		PracticeType: string(practiceMaterialDb.PracticeType),
		TimeToAnswer: practiceMaterialDb.TimeToAnswer,
		CreatedAt:    *utils.MarshalPgTimestamp(practiceMaterialDb.CreatedAt),
		UpdatedAt:    *utils.MarshalPgTimestamp(practiceMaterialDb.UpdatedAt),
	}
	return practiceMaterial, nil
}
