package services

import (
	"context"
	db "mw-training/internal/db/sqlc"
	pb "mw-training/pkg/grpcAutogenerated/training"
	"mw-training/pkg/utils"

	"github.com/jackc/pgx/v5"
	"github.com/jackc/pgx/v5/pgtype"
	"github.com/jackc/pgx/v5/pgxpool"
)

type TopicRepository interface {
	CreateTopicInTraining(ctx context.Context, params db.CreateTopicInTrainingParams) (db.Topic, error)
	UpdateTopic(ctx context.Context, params db.UpdateTopicParams) (db.Topic, error)
	DeleteTopic(ctx context.Context, topicUuid pgtype.UUID) (db.Topic, error)
	GetTopicByUuid(ctx context.Context, topicUuid pgtype.UUID) (db.GetTopicByUuidRow, error)
	WithTx(tx pgx.Tx) *db.Queries
}

type TopicService struct {
	topicRepository TopicRepository
	pgxPool         *pgxpool.Pool
}

func NewTopicService(pgxPool *pgxpool.Pool, topicRepository TopicRepository) *TopicService {
	return &TopicService{
		pgxPool:         pgxPool,
		topicRepository: topicRepository,
	}
}

func (ts *TopicService) CreateTopic(ctx context.Context, params db.CreateTopicInTrainingParams) (*pb.TopicPreview, error) {
	topicRaw, err := ts.topicRepository.CreateTopicInTraining(ctx, params)
	if err != nil {
		return &pb.TopicPreview{}, err
	}

	topic, err := ts.topicRepository.GetTopicByUuid(ctx, topicRaw.Uuid)
	if err != nil {
		return &pb.TopicPreview{}, err
	}

	return &pb.TopicPreview{
		Uuid:                    *utils.MarshalPgUUID(topic.Uuid),
		Name:                    topic.Name.String,
		TrainingUuid:            *utils.MarshalPgUUID(topic.TrainingUuid),
		TopicOrder:              topic.TopicOrder,
		ParentTopicUuid:         utils.MarshalPgUUID(topic.Parent),
		CreatedAt:               topic.CreatedAt.Time.String(),
		TheoryMaterialsAmount:   int32(topic.TheoryMaterialsAmount),
		PracticeMaterialsAmount: int32(topic.PracticeMaterialsAmount),
	}, nil
}

func (ts *TopicService) UpdateTopic(ctx context.Context, params db.UpdateTopicParams) (*pb.TopicPreview, error) {
	topicRaw, err := ts.topicRepository.UpdateTopic(ctx, params)
	if err != nil {
		return &pb.TopicPreview{}, err
	}

	topic, err := ts.topicRepository.GetTopicByUuid(ctx, topicRaw.Uuid)
	if err != nil {
		return &pb.TopicPreview{}, err
	}

	return &pb.TopicPreview{
		Uuid:                    *utils.MarshalPgUUID(topic.Uuid),
		Name:                    topic.Name.String,
		TrainingUuid:            *utils.MarshalPgUUID(topic.TrainingUuid),
		TopicOrder:              topic.TopicOrder,
		ParentTopicUuid:         utils.MarshalPgUUID(topic.Parent),
		CreatedAt:               topic.CreatedAt.Time.String(),
		TheoryMaterialsAmount:   int32(topic.TheoryMaterialsAmount),
		PracticeMaterialsAmount: int32(topic.PracticeMaterialsAmount),
	}, nil
}

func (ts *TopicService) DeleteTopic(ctx context.Context, topicUuid pgtype.UUID) (db.Topic, error) {
	return ts.topicRepository.DeleteTopic(ctx, topicUuid)
}
