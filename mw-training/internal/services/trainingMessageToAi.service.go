package services

import (
	"context"
	"fmt"
	db "mw-training/internal/db/sqlc"
	pb "mw-training/pkg/grpcAutogenerated/training"
	"mw-training/pkg/utils"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5"
	"github.com/jackc/pgx/v5/pgtype"
	"github.com/jackc/pgx/v5/pgxpool"
)

type TrainingMessageToAiRepository interface {
	GetNextMessageToAI(ctx context.Context) (db.MessagesToGenerateWithAi, error)
	GetMessageToAIById(ctx context.Context, messageToGenerateWithAiUuid pgtype.UUID) (db.MessagesToGenerateWithAi, error)
	DeleteMessageToAI(ctx context.Context, messageToGenerateWithAiUuid pgtype.UUID) error
	WithTx(tx pgx.Tx) *db.Queries
}

type TrainingMessageToAiService struct {
	trainingMessageToAiRepository TrainingMessageToAiRepository
	pgxPool                       *pgxpool.Pool
}

func NewTrainingMessageToAiService(pgxPool *pgxpool.Pool, trainingMessageToAiRepository TrainingMessageToAiRepository) *TrainingMessageToAiService {
	return &TrainingMessageToAiService{
		pgxPool:                       pgxPool,
		trainingMessageToAiRepository: trainingMessageToAiRepository,
	}
}

func (ts *TrainingMessageToAiService) GetMessageToAI(ctx context.Context) (*pb.MessageToAI, error) {
	messageToAiRaw, err := ts.trainingMessageToAiRepository.GetNextMessageToAI(ctx)
	if err != nil {
		return &pb.MessageToAI{}, err
	}

	// TODO: add all what I need
	// MessageType: messageToAiRaw.MessageType.String,
	// TrainingUuid: *utils.MarshalPgUUID(messageToAiRaw.TrainingUuid),
	// OwnerUuid:   *utils.MarshalPgUUID(messageToAiRaw.OwnerUuid),
	// CreatedAt:   messageToAiRaw.CreatedAt.Time.String(),
	message := "TODO add all what I need"
	messageToAi := &pb.MessageToAI{
		Uuid:    *utils.MarshalPgUUID(messageToAiRaw.Uuid),
		Message: message,
	}

	return messageToAi, nil
}

func (ts *TrainingMessageToAiService) HandleResponseFromAiForItem(ctx context.Context, params *pb.MessageFromAI) error {
	messageToAiRaw, err := ts.trainingMessageToAiRepository.GetMessageToAIById(
		ctx,
		pgtype.UUID{Bytes: uuid.MustParse(params.Uuid), Valid: true},
	)
	if err != nil {
		return err
	}

	// just for example
	fmt.Printf(messageToAiRaw.CreatedAt.Time.String())

	// TODO
	// handle response
	// use params.MessageResponse
	// and data from db
	// use switch case to handle different types of messages

	return nil
}
