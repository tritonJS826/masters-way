package services

import (
	"context"
	db "mw-training/internal/db/sqlc"
	pb "mw-training/pkg/grpcAutogenerated/training"
	"mw-training/pkg/utils"

	"github.com/jackc/pgx/v5"
	"github.com/jackc/pgx/v5/pgtype"
	"github.com/jackc/pgx/v5/pgxpool"
	"github.com/samber/lo"
)

type QuestionResultRepository interface {
	CreateQuestionResult(ctx context.Context, params db.CreateQuestionResultParams) (db.QuestionResult, error)
	GetQuestionResultsBySessionUuid(ctx context.Context, testSessionUuid pgtype.UUID) ([]db.GetQuestionResultsBySessionUuidRow, error)
	GetQuestionResultById(ctx context.Context, result_uuid pgtype.UUID) (db.GetQuestionResultByIdRow, error)
	WithTx(tx pgx.Tx) *db.Queries
}

type QuestionResultService struct {
	questionResultRepository QuestionResultRepository
	pgxPool                  *pgxpool.Pool
}

func NewQuestionResultService(pgxPool *pgxpool.Pool, questionResultRepository QuestionResultRepository) *QuestionResultService {
	return &QuestionResultService{
		pgxPool:                  pgxPool,
		questionResultRepository: questionResultRepository,
	}
}

func (ts *QuestionResultService) CreateQuestionResult(ctx context.Context, params db.CreateQuestionResultParams) (*pb.QuestionResult, error) {
	questionResultDbRaw, err := ts.questionResultRepository.CreateQuestionResult(ctx, params)
	if err != nil {
		return &pb.QuestionResult{}, err
	}

	questionResultDb, err := ts.questionResultRepository.GetQuestionResultById(ctx, questionResultDbRaw.Uuid)
	if err != nil {
		return &pb.QuestionResult{}, err
	}

	return &pb.QuestionResult{
		Uuid:                *utils.MarshalPgUUID(questionResultDb.Uuid),
		QuestionUuid:        *utils.MarshalPgUUID(questionResultDb.QuestionUuid),
		UserUuid:            *utils.MarshalPgUUID(questionResultDb.UserUuid),
		QuestionName:        questionResultDb.QuestionName.String,
		QuestionDescription: questionResultDb.QuestionText,
		QuestionAnswer:      questionResultDb.QuestionAnswer,
		UserAnswer:          questionResultDb.QuestionAnswer,
		IsOk:                questionResultDb.IsOk,
		ResultDescription:   questionResultDb.ResultDescription,
	}, nil
}

func (ts *QuestionResultService) GetQuestionResultsBySessionUuid(ctx context.Context, sessionUuid pgtype.UUID) ([]*pb.QuestionResult, error) {
	questionResultsDb, err := ts.questionResultRepository.GetQuestionResultsBySessionUuid(ctx, sessionUuid)
	if err != nil {
		return nil, err
	}

	questionResults := lo.Map(questionResultsDb, func(questionResultDb db.GetQuestionResultsBySessionUuidRow, _ int) *pb.QuestionResult {
		return &pb.QuestionResult{
			Uuid:                *utils.MarshalPgUUID(questionResultDb.Uuid),
			QuestionUuid:        *utils.MarshalPgUUID(questionResultDb.QuestionUuid),
			UserUuid:            *utils.MarshalPgUUID(questionResultDb.UserUuid),
			QuestionName:        questionResultDb.QuestionName.String,
			QuestionDescription: questionResultDb.QuestionText,
			QuestionAnswer:      questionResultDb.QuestionAnswer,
			UserAnswer:          questionResultDb.UserAnswer,
			IsOk:                questionResultDb.IsOk,
			ResultDescription:   questionResultDb.ResultDescription,
		}
	})

	return questionResults, nil
}
