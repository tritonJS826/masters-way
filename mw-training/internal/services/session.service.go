package services

import (
	"context"
	db "mw-training/internal/db/sqlc"
	pb "mw-training/pkg/grpcAutogenerated/training"
	"mw-training/pkg/utils"

	"github.com/jackc/pgx/v5"
	"github.com/jackc/pgx/v5/pgtype"
	"github.com/jackc/pgx/v5/pgxpool"
)

type SessionRepository interface {
	CreateTestSession(ctx context.Context) (pgtype.UUID, error)
	WithTx(tx pgx.Tx) *db.Queries
}

type SessionService struct {
	sessionRepository SessionRepository
	pgxPool           *pgxpool.Pool
}

func NewSessionService(pgxPool *pgxpool.Pool, sessionRepository SessionRepository) *SessionService {
	return &SessionService{
		pgxPool:           pgxPool,
		sessionRepository: sessionRepository,
	}
}

func (ts *SessionService) CreateSession(ctx context.Context, userUuid pgtype.UUID) (*pb.CreateSessionResult, error) {
	// TODO: use userUuid to create a session for the user or users

	sessionResultDb, err := ts.sessionRepository.CreateTestSession(ctx)
	if err != nil {
		return nil, err
	}

	return &pb.CreateSessionResult{
		SessionUuid: *utils.MarshalPgUUID(sessionResultDb),
	}, nil
}
