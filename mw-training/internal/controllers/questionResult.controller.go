package controllers

import (
	"context"
	db "mw-training/internal/db/sqlc"

	services "mw-training/internal/services"

	pb "mw-training/pkg/grpcAutogenerated/training"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
)

type QuestionResultController struct {
	questionResultService *services.QuestionResultService
	pb.UnimplementedQuestionResultsServiceServer
}

func NewQuestionResultController(questionResultService *services.QuestionResultService) *QuestionResultController {
	return &QuestionResultController{questionResultService: questionResultService}
}

func (c *QuestionResultController) CreateQuestionResult(ctx context.Context, in *pb.CreateQuestionResultRequest) (*pb.QuestionResult, error) {
	questionUuid := in.GetQuestionUuid()
	userUuid := in.GetUserUuid()
	testUuid := in.GetTestUuid()
	testSessionUuid := in.GetTestSessionUuid()
	isOk := in.GetIsOk()
	resultDescription := in.GetResultDescription()

	args := db.CreateQuestionResultParams{
		QuestionUuid:      pgtype.UUID{Bytes: uuid.MustParse(questionUuid), Valid: true},
		UserUuid:          pgtype.UUID{Bytes: uuid.MustParse(userUuid), Valid: true},
		TestUuid:          pgtype.UUID{Bytes: uuid.MustParse(testUuid), Valid: true},
		IsOk:              isOk,
		ResultDescription: resultDescription,
		TestSessionUuid:   pgtype.UUID{Bytes: uuid.MustParse(testSessionUuid), Valid: true},
	}

	questionResult, err := c.questionResultService.CreateQuestionResult(ctx, args)

	return questionResult, err
}

func (c *QuestionResultController) GetQuestionResultsBySessionUuid(ctx context.Context, in *pb.GetQuestionResultsBySessionUuidRequest) (*pb.GetQuestionResultsBySessionUuidResponse, error) {
	sessionUuidRaw := in.GetSessionUuid()

	// TODO use userUuid for security (check relations)
	// userUuid := in.GetUserUuid()

	sessionUuid := pgtype.UUID{Bytes: uuid.MustParse(sessionUuidRaw), Valid: true}

	questionResults, err := c.questionResultService.GetQuestionResultsBySessionUuid(ctx, sessionUuid)
	if err != nil {
		return nil, err
	}

	return &pb.GetQuestionResultsBySessionUuidResponse{
		Results: questionResults,
	}, nil
}
