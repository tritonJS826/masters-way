package controllers

import (
	"context"

	db "mw-training/internal/db/sqlc"
	services "mw-training/internal/services"
	pb "mw-training/pkg/grpcAutogenerated/training"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
	"google.golang.org/protobuf/types/known/emptypb"
)

type PracticeMaterialController struct {
	practiceMaterialService *services.PracticeMaterialService
	pb.PracticeMaterialServiceServer
}

func NewPracticeMaterialController(practiceMaterialService *services.PracticeMaterialService) *PracticeMaterialController {
	return &PracticeMaterialController{practiceMaterialService: practiceMaterialService}
}

func (ftc *PracticeMaterialController) CreatePracticeMaterial(ctx context.Context, in *pb.CreatePracticeMaterialRequest) (*pb.PracticeMaterial, error) {
	topicUuid := in.GetTopicUuid()
	name := in.GetName()
	order := in.GetOrder()
	description := in.GetDescription()
	answer := in.GetAnswer()
	practiceType := in.GetPracticeType()
	timeToAnswer := in.GetTimeToAnswer()

	arg := db.CreatePracticeMaterialInTopicParams{
		TopicUuid:             pgtype.UUID{Bytes: uuid.MustParse(topicUuid), Valid: true},
		Name:                  pgtype.Text{String: name, Valid: true},
		PracticeMaterialOrder: order,
		TaskDescription:       pgtype.Text{String: description, Valid: true},
		Answer:                pgtype.Text{String: answer, Valid: true},
		PracticeType:          db.PracticeType(practiceType),
		TimeToAnswer:          timeToAnswer,
	}

	practiceMaterial, err := ftc.practiceMaterialService.CreatePracticeMaterial(ctx, arg)
	if err != nil {
		return nil, err
	}

	return practiceMaterial, nil
}

func (pmc *PracticeMaterialController) UpdatePracticeMaterial(ctx context.Context, in *pb.UpdatePracticeMaterialRequest) (*pb.PracticeMaterial, error) {
	practiceMaterialName := in.GetName()
	practiceMaterialUuid := in.GetUuid()
	description := in.GetDescription()
	answer := in.GetAnswer()
	practiceType := in.GetPracticeType()
	timeToAnswer := in.GetTimeToAnswer()

	arg := db.UpdatePracticeMaterialParams{
		Name:            pgtype.Text{String: practiceMaterialName, Valid: true},
		Uuid:            pgtype.UUID{Bytes: uuid.MustParse(practiceMaterialUuid), Valid: true},
		TaskDescription: pgtype.Text{String: description, Valid: true},
		TimeToAnswer:    pgtype.Int4{Int32: timeToAnswer, Valid: true},
		Answer:          pgtype.Text{String: answer, Valid: true},
		PracticeType:    db.NullPracticeType{PracticeType: db.PracticeType(practiceType), Valid: true},
	}
	practiceMaterial, err := pmc.practiceMaterialService.UpdatePracticeMaterial(ctx, arg)
	if err != nil {
		return nil, err
	}
	return practiceMaterial, nil
}

func (ftc *PracticeMaterialController) DeletePracticeMaterial(ctx context.Context, in *pb.DeletePracticeMaterialRequest) (*emptypb.Empty, error) {
	practiceMaterialUuid := in.GetMaterialUuid()

	_, err := ftc.practiceMaterialService.DeletePracticeMaterial(ctx, pgtype.UUID{Bytes: uuid.MustParse(practiceMaterialUuid), Valid: true})
	if err != nil {
		return nil, err
	}

	return &emptypb.Empty{}, nil
}
