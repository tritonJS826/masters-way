package controllers

import (
	"context"
	db "mw-training/internal/db/sqlc"
	services "mw-training/internal/services"

	pb "mw-training/pkg/grpcAutogenerated/training"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
	"google.golang.org/protobuf/types/known/emptypb"
)

type TrainingTestsController struct {
	trainingTestService *services.TrainingTestService
	pb.UnimplementedTrainingTestsServiceServer
}

func NewTrainingTestController(trainingTestService *services.TrainingTestService) *TrainingTestsController {
	return &TrainingTestsController{trainingTestService: trainingTestService}
}

func (c *TrainingTestsController) CreateTrainingTest(ctx context.Context, in *pb.CreateTrainingTestRequest) (*emptypb.Empty, error) {

	trainingUuid := in.GetTrainingUuid()
	testUuid := in.GetTestUuid()

	// TODO use testOwnerUuid for security (check relations)
	// testOwnerUuid := in.GetTestOwnerUuid()

	args := &db.CreateTrainingsTestsParams{
		TrainingUuid: pgtype.UUID{Bytes: uuid.MustParse(trainingUuid), Valid: true},
		TestUuid:     pgtype.UUID{Bytes: uuid.MustParse(testUuid), Valid: true},
	}
	err := c.trainingTestService.CreateTrainingTest(ctx, args)
	if err != nil {
		return &emptypb.Empty{}, err
	}

	return &emptypb.Empty{}, nil
}
