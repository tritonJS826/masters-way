package controllers

import (
	"context"

	db "mw-training/internal/db/sqlc"
	services "mw-training/internal/services"
	pb "mw-training/pkg/grpcAutogenerated/training"
	"mw-training/pkg/utils"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
	"google.golang.org/protobuf/types/known/emptypb"
)

type TheoryMaterialController struct {
	theoryMaterialService *services.TheoryMaterialService
	pb.TheoryMaterialServiceServer
}

func NewTheoryMaterialController(theoryMaterialService *services.TheoryMaterialService) *TheoryMaterialController {
	return &TheoryMaterialController{theoryMaterialService: theoryMaterialService}
}

func (ftc *TheoryMaterialController) CreateTheoryMaterial(ctx context.Context, in *pb.CreateTheoryMaterialRequest) (*pb.TheoryMaterial, error) {
	topicUuid := in.GetTopicUuid()
	name := in.GetName()
	description := in.GetDescription()

	arg := db.CreateTheoryMaterialInTopicParams{
		TopicUuid:   pgtype.UUID{Bytes: uuid.MustParse(topicUuid), Valid: true},
		Name:        pgtype.Text{String: name, Valid: true},
		Description: pgtype.Text{String: description, Valid: true},
	}

	theoryMaterialDb, err := ftc.theoryMaterialService.CreateTheoryMaterial(ctx, arg)
	if err != nil {
		return nil, err
	}

	theoryMaterial := &pb.TheoryMaterial{
		Uuid:        *utils.MarshalPgUUID(theoryMaterialDb.Uuid),
		TopicUuid:   *utils.MarshalPgUUID(theoryMaterialDb.TopicUuid),
		Name:        theoryMaterialDb.Name.String,
		Description: theoryMaterialDb.Description.String,
		CreatedAt:   *utils.MarshalPgTimestamp(theoryMaterialDb.CreatedAt),
		UpdatedAt:   *utils.MarshalPgTimestamp(theoryMaterialDb.UpdatedAt),
	}

	return theoryMaterial, nil
}

func (pmc *TheoryMaterialController) UpdateTheoryMaterial(ctx context.Context, in *pb.UpdateTheoryMaterialRequest) (*pb.TheoryMaterial, error) {
	theoryMaterialUuid := in.GetUuid()
	theoryMaterialNameRaw := in.Name
	descriptionRaw := in.Description

	var theoryMaterialName string
	if theoryMaterialNameRaw != nil {
		theoryMaterialName = *theoryMaterialNameRaw
	} else {
		theoryMaterialName = ""
	}

	var description string
	if descriptionRaw != nil {
		description = *descriptionRaw
	} else {
		description = ""
	}
	arg := db.UpdateTheoryMaterialParams{
		Uuid:        pgtype.UUID{Bytes: uuid.MustParse(theoryMaterialUuid), Valid: true},
		Name:        pgtype.Text{String: theoryMaterialName, Valid: theoryMaterialNameRaw != nil},
		Description: pgtype.Text{String: description, Valid: descriptionRaw != nil},
	}
	theoryMaterial, err := pmc.theoryMaterialService.UpdateTheoryMaterial(ctx, arg)
	if err != nil {
		return nil, err
	}
	return &pb.TheoryMaterial{
		Uuid:        *utils.MarshalPgUUID(theoryMaterial.Uuid),
		Name:        theoryMaterial.Name.String,
		TopicUuid:   *utils.MarshalPgUUID(theoryMaterial.TopicUuid),
		Description: theoryMaterial.Description.String,
		CreatedAt:   *utils.MarshalPgTimestamp(theoryMaterial.CreatedAt),
		UpdatedAt:   *utils.MarshalPgTimestamp(theoryMaterial.UpdatedAt),
	}, nil
}

func (ftc *TheoryMaterialController) DeleteTheoryMaterial(ctx context.Context, in *pb.DeleteTheoryMaterialRequest) (*emptypb.Empty, error) {
	theoryMaterialUuid := in.GetUuid()

	_, err := ftc.theoryMaterialService.DeleteTheoryMaterial(ctx, pgtype.UUID{Bytes: uuid.MustParse(theoryMaterialUuid), Valid: true})
	if err != nil {
		return nil, err
	}

	return &emptypb.Empty{}, nil
}
