package controllers

import (
	"context"

	db "mw-training/internal/db/sqlc"
	services "mw-training/internal/services"
	pb "mw-training/pkg/grpcAutogenerated/training"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
	"google.golang.org/protobuf/types/known/emptypb"
)

type TheoryMaterialController struct {
	theoryMaterialService *services.TheoryMaterialService
	pb.TheoryMaterialServiceServer
}

func NewTheoryMaterialController(theoryMaterialService *services.TheoryMaterialService) *TheoryMaterialController {
	return &TheoryMaterialController{theoryMaterialService: theoryMaterialService}
}

func (ftc *TheoryMaterialController) CreateTheoryMaterial(ctx context.Context, in *pb.CreateTheoryMaterialRequest) (*db.TheoryMaterial, error) {
	topicUuid := in.GetTopicUuid()
	name := in.GetName()
	description := in.GetDescription()

	arg := db.CreateTheoryMaterialInTopicParams{
		TopicUuid:   pgtype.UUID{Bytes: uuid.MustParse(topicUuid), Valid: true},
		Name:        pgtype.Text{String: name, Valid: true},
		Description: pgtype.Text{String: description, Valid: true},
	}

	theoryMaterial, err := ftc.theoryMaterialService.CreateTheoryMaterial(ctx, arg)
	if err != nil {
		return nil, err
	}

	return &theoryMaterial, nil
}

func (pmc *TheoryMaterialController) UpdateTheoryMaterial(ctx context.Context, in *pb.UpdateTheoryMaterialRequest) (*pb.TheoryMaterial, error) {
	theoryMaterialName := in.GetName()
	theoryMaterialUuid := in.GetUuid()
	description := in.GetDescription()

	arg := db.UpdateTheoryMaterialParams{
		Name:        pgtype.Text{String: theoryMaterialName, Valid: true},
		Uuid:        pgtype.UUID{Bytes: uuid.MustParse(theoryMaterialUuid), Valid: true},
		Description: pgtype.Text{String: description, Valid: true},
	}
	theoryMaterial, err := pmc.theoryMaterialService.UpdateTheoryMaterial(ctx, arg)
	if err != nil {
		return nil, err
	}
	return &theoryMaterial, nil
}

func (ftc *TheoryMaterialController) DeleteTheoryMaterial(ctx context.Context, in *pb.DeleteTheoryMaterialRequest) (*emptypb.Empty, error) {
	theoryMaterialUuid := in.GetUuid()

	err := ftc.theoryMaterialService.DeleteTheoryMaterial(ctx, pgtype.UUID{Bytes: uuid.MustParse(theoryMaterialUuid), Valid: true})
	if err != nil {
		return nil, err
	}

	return &emptypb.Empty{}, nil
}
