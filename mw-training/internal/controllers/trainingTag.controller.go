package controllers

import (
	"context"

	db "mw-training/internal/db/sqlc"
	services "mw-training/internal/services"
	pb "mw-training/pkg/grpcAutogenerated/training"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
	"google.golang.org/protobuf/types/known/emptypb"
)

type TrainingTagController struct {
	trainingService *services.TrainingTagService
	pb.TheoryMaterialServiceServer
}

func NewTrainingTagController(trainingService *services.TrainingTagService) *TrainingTagController {
	return &TrainingTagController{trainingService: trainingService}
}

func (tc *TrainingTagController) CreateTrainingTag(ctx context.Context, in *pb.CreateTrainingTagRequest) (*db.TrainingTag, error) {
	trainingUuid := in.GetTrainingTagUuid()
	name := in.GetName()
	trainingOrder := in.GetTrainingTagOrder()
	parentTrainingTagUuid := in.GetParentTrainingTagUuid()

	arg := db.CreateTrainingTagInTrainingTagParams{
		TrainingTagUuid:  pgtype.UUID{Bytes: uuid.MustParse(trainingUuid), Valid: true},
		Name:             pgtype.Text{String: name, Valid: true},
		TrainingTagOrder: trainingOrder,
		Parent:           pgtype.UUID{Bytes: uuid.MustParse(parentTrainingTagUuid), Valid: true},
	}

	trainingTag, err := tc.trainingService.CreateTrainingTag(ctx, arg)
	if err != nil {
		return nil, err
	}

	return &trainingTag, nil
}

func (tc *TrainingTagController) UpdateTrainingTag(ctx context.Context, in *pb.UpdateTrainingTagRequest) (*pb.TrainingTag, error) {
	trainingName := in.GetName()
	trainingUuid := in.GetUuid()

	arg := db.UpdateTrainingTagParams{
		Name: pgtype.Text{String: trainingName, Valid: true},
		Uuid: pgtype.UUID{Bytes: uuid.MustParse(trainingUuid), Valid: true},
	}
	trainingTag, err := tc.trainingService.UpdateTrainingTag(ctx, arg)
	if err != nil {
		return nil, err
	}
	return &trainingTag, nil
}

func (tc *TrainingTagController) DeleteTrainingTag(ctx context.Context, in *pb.DeleteTrainingTagRequest) (*emptypb.Empty, error) {
	trainingUuid := in.GetTrainingTagUuid()

	err := tc.trainingService.DeleteTrainingTag(ctx, pgtype.UUID{Bytes: uuid.MustParse(trainingUuid), Valid: true})
	if err != nil {
		return nil, err
	}

	return &emptypb.Empty{}, nil
}
