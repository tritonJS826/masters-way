package controllers

import (
	"context"
	services "mw-training/internal/services"

	pb "mw-training/pkg/grpcAutogenerated/training"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
)

type TestSessionResultController struct {
	testSessionService *services.TestSessionResultService
	pb.UnimplementedTestSessionResultsServiceServer
}

func NewTestSessionResultController(testSessionService *services.TestSessionResultService) *TestSessionResultController {
	return &TestSessionResultController{testSessionService: testSessionService}
}

func (c *TestSessionResultController) GetTestSessionResult(ctx context.Context, in *pb.GetTestSessionResultRequest) (*pb.GetTestSessionResultResponse, error) {
	sessionUuid := in.GetSessionUuid()

	// TODO use userUuid for security (check relations)
	// userUuid := in.GetUserUuid()

	args := pgtype.UUID{Bytes: uuid.MustParse(sessionUuid), Valid: true}

	tesSessionResult, err := c.testSessionService.GetTestSessionResult(ctx, args)
	if err != nil {
		return nil, err
	}

	return tesSessionResult, nil
}

func (c *TestSessionResultController) CreateTestSessionResult(ctx context.Context, in *pb.CreateTestSessionResultRequest) (*pb.GetTestSessionResultResponse, error) {
	sessionUuid := in.GetSessionUuid()
	userUuid := in.GetUserUuid()
	testUuid := in.GetTestUuid()
	resultDescription := in.GetResultDescription()

	// TODO use userUuid for security (check relations)

	args := services.CreateTestSessionResultParams{
		TestUuid:          pgtype.UUID{Bytes: uuid.MustParse(testUuid), Valid: true},
		UserUuid:          pgtype.UUID{Bytes: uuid.MustParse(userUuid), Valid: true},
		SessionUuid:       pgtype.UUID{Bytes: uuid.MustParse(sessionUuid), Valid: true},
		ResultDescription: resultDescription,
	}

	tesSessionResult, err := c.testSessionService.CreateTestSessionResult(ctx, args)
	if err != nil {
		return nil, err
	}

	return tesSessionResult, nil
}
