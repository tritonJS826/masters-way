package controllers

import (
	"context"

	db "mw-training/internal/db/sqlc"
	services "mw-training/internal/services"
	pb "mw-training/pkg/grpcAutogenerated/training"
	"mw-training/pkg/utils"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
	"google.golang.org/protobuf/types/known/emptypb"
)

type TopicController struct {
	topicService *services.TopicService
	pb.TopicsServiceServer
}

func NewTopicController(topicService *services.TopicService) *TopicController {
	return &TopicController{topicService: topicService}
}

func (tc *TopicController) CreateTopic(ctx context.Context, in *pb.CreateTopicRequest) (*pb.Topic, error) {
	trainingUuid := in.GetTrainingUuid()
	name := in.GetName()
	topicOrder := in.GetTopicOrder()
	parentTopicUuid := in.GetParentTopicUuid()

	arg := db.CreateTopicInTrainingParams{
		TrainingUuid: pgtype.UUID{Bytes: uuid.MustParse(trainingUuid), Valid: true},
		Name:         pgtype.Text{String: name, Valid: true},
		TopicOrder:   topicOrder,
		Parent:       pgtype.UUID{Bytes: uuid.MustParse(parentTopicUuid), Valid: true},
	}

	topicDb, err := tc.topicService.CreateTopic(ctx, arg)
	if err != nil {
		return nil, err
	}

	topic := &pb.Topic{
		Uuid:            *utils.MarshalPgUUID(topicDb.Uuid),
		Name:            topicDb.Name.String,
		TrainingUuid:    *utils.MarshalPgUUID(topicDb.TrainingUuid),
		TopicOrder:      topicDb.TopicOrder,
		ParentTopicUuid: *utils.MarshalPgUUID(topicDb.Parent),
		CreatedAt:       *utils.MarshalPgTimestamp(topicDb.CreatedAt),
	}

	return topic, nil
}

func (tc *TopicController) UpdateTopic(ctx context.Context, in *pb.UpdateTopicRequest) (*pb.Topic, error) {
	topicName := in.GetName()
	topicUuid := in.GetUuid()

	arg := db.UpdateTopicParams{
		Name: pgtype.Text{String: topicName, Valid: true},
		Uuid: pgtype.UUID{Bytes: uuid.MustParse(topicUuid), Valid: true},
	}
	topic, err := tc.topicService.UpdateTopic(ctx, arg)
	if err != nil {
		return nil, err
	}
	return &pb.Topic{
		Uuid:            *utils.MarshalPgUUID(topic.Uuid),
		Name:            topic.Name.String,
		TrainingUuid:    *utils.MarshalPgUUID(topic.TrainingUuid),
		TopicOrder:      topic.TopicOrder,
		ParentTopicUuid: *utils.MarshalPgUUID(topic.Parent),
		CreatedAt:       *utils.MarshalPgTimestamp(topic.CreatedAt),
	}, nil
}

func (tc *TopicController) DeleteTopic(ctx context.Context, in *pb.DeleteTopicRequest) (*emptypb.Empty, error) {
	topicUuid := in.GetTopicUuid()

	_, err := tc.topicService.DeleteTopic(ctx, pgtype.UUID{Bytes: uuid.MustParse(topicUuid), Valid: true})
	if err != nil {
		return nil, err
	}

	return &emptypb.Empty{}, nil
}
