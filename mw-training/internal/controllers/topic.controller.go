package controllers

import (
	"context"
	"fmt"

	db "mw-training/internal/db/sqlc"
	services "mw-training/internal/services"
	pb "mw-training/pkg/grpcAutogenerated/training"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
	"github.com/samber/lo"
	"google.golang.org/protobuf/types/known/emptypb"
)

type TopicController struct {
	topicService *services.TopicService
	pb.TopicsServiceServer
}

func NewTopicController(topicService *services.TopicService) *TopicController {
	return &TopicController{topicService: topicService}
}

func (tc *TopicController) CreateTopics(ctx context.Context, in *pb.CreateTopicsRequest) (*pb.TopicsPreview, error) {
	createTopicsRequest := in.GetCreateTopicRequest()

	topics := lo.Map(createTopicsRequest, func(topic *pb.CreateTopicRequest, _ int) *pb.TopicPreview {
		name := topic.GetName()
		trainingUuid := topic.GetTrainingUuid()
		topicOrder := topic.GetTopicOrder()
		parentTopicUuidRaw := topic.ParentTopicUuid

		var parentTopicUuid pgtype.UUID
		if parentTopicUuidRaw != nil {
			parentTopicUuid = pgtype.UUID{Bytes: uuid.MustParse(*parentTopicUuidRaw), Valid: true}
		} else {
			parentTopicUuid = pgtype.UUID{Valid: false}
		}

		arg := db.CreateTopicInTrainingParams{
			Name:         pgtype.Text{String: name, Valid: true},
			TrainingUuid: pgtype.UUID{Bytes: uuid.MustParse(trainingUuid), Valid: true},
			TopicOrder:   topicOrder,
			Parent:       parentTopicUuid,
		}

		topicResponse, err := tc.topicService.CreateTopic(ctx, arg)
		if err != nil {
			// TODO: handle error
			fmt.Println("Ups, cant create topic!! " + err.Error())
		}

		return topicResponse
	})

	response := &pb.TopicsPreview{
		TopicsPreview: topics,
	}

	return response, nil
}

func (tc *TopicController) GetTopicById(ctx context.Context, in *pb.GetTopicByIdRequest) (*pb.Topic, error) {
	topicUuid := in.GetTopicUuid()

	arg := pgtype.UUID{Bytes: uuid.MustParse(topicUuid), Valid: true}

	topic, err := tc.topicService.GetTopicByUuid(ctx, arg)
	if err != nil {
		return nil, err
	}

	return topic, nil
}

func (tc *TopicController) UpdateTopic(ctx context.Context, in *pb.UpdateTopicRequest) (*pb.TopicPreview, error) {
	topicName := in.GetName()
	topicUuid := in.GetUuid()

	arg := db.UpdateTopicParams{
		Name: pgtype.Text{String: topicName, Valid: true},
		Uuid: pgtype.UUID{Bytes: uuid.MustParse(topicUuid), Valid: true},
	}
	topic, err := tc.topicService.UpdateTopic(ctx, arg)
	if err != nil {
		return nil, err
	}
	return &pb.TopicPreview{
		Uuid:                    topic.Uuid,
		Name:                    topic.Name,
		TrainingUuid:            topic.TrainingUuid,
		TopicOrder:              topic.TopicOrder,
		ParentTopicUuid:         topic.ParentTopicUuid,
		CreatedAt:               topic.CreatedAt,
		TheoryMaterialsAmount:   topic.TheoryMaterialsAmount,
		PracticeMaterialsAmount: topic.PracticeMaterialsAmount,
	}, nil
}

func (tc *TopicController) DeleteTopic(ctx context.Context, in *pb.DeleteTopicRequest) (*emptypb.Empty, error) {
	topicUuid := in.GetTopicUuid()

	_, err := tc.topicService.DeleteTopic(ctx, pgtype.UUID{Bytes: uuid.MustParse(topicUuid), Valid: true})
	if err != nil {
		return nil, err
	}

	return &emptypb.Empty{}, nil
}
