package controllers

import (
	"context"

	db "mw-training/internal/db/sqlc"
	services "mw-training/internal/services"
	pb "mw-training/pkg/grpcAutogenerated/training"
	"mw-training/pkg/utils"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
	"google.golang.org/protobuf/types/known/emptypb"
)

type TrainingTrainingTagController struct {
	trainingTrainingTagService *services.TrainingTrainingTagService
	pb.TrainingTrainingTagServiceServer
}

// TODO: looks like we don't need this controller
func (tc *TrainingTrainingTagController) GetTrainingTags(context.Context, *pb.GetTrainingTagsRequest) (*pb.TrainingTagList, error) {
	panic("unimplemented")
}

func NewTrainingTagController(trainingTrainingTagService *services.TrainingTrainingTagService) *TrainingTrainingTagController {
	return &TrainingTrainingTagController{trainingTrainingTagService: trainingTrainingTagService}
}

func (tc *TrainingTrainingTagController) CreateTrainingTrainingTag(ctx context.Context, in *pb.CreateTrainingTagRequest) (*pb.TrainingTag, error) {
	trainingUuid := in.GetTrainingUuid()
	name := in.GetTagName()

	arg := db.CreateTrainingTrainingTagParams{
		TrainingUuid: pgtype.UUID{Bytes: uuid.MustParse(trainingUuid), Valid: true},
		// TODO: IT's just a stub
		TagUuid: pgtype.UUID{Bytes: uuid.MustParse(name), Valid: true},
	}

	trainingTag, err := tc.trainingTrainingTagService.CreateTrainingTrainingTag(ctx, arg)
	if err != nil {
		return nil, err
	}

	return &pb.TrainingTag{
		TagName: "Stub tag name" + *utils.MarshalPgUUID(trainingTag.TagUuid),
	}, nil
}

func (tc *TrainingTrainingTagController) DeleteTrainingTrainingTag(ctx context.Context, in *pb.DeleteTrainingTagRequest) (*emptypb.Empty, error) {
	trainingUuid := in.GetTrainingUuid()
	tagName := in.GetTagName()

	arg := db.DeleteTrainingsTrainingTagParams{
		TrainingUuid: pgtype.UUID{Bytes: uuid.MustParse(trainingUuid), Valid: true},
		TagUuid:      pgtype.UUID{Bytes: uuid.MustParse(tagName), Valid: true},
	}

	err := tc.trainingTrainingTagService.DeleteTrainingTrainingTag(ctx, arg)
	if err != nil {
		return nil, err
	}

	return &emptypb.Empty{}, nil
}
