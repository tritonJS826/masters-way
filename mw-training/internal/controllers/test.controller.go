package controllers

import (
	"context"
	db "mw-training/internal/db/sqlc"
	"mw-training/internal/services"
	pb "mw-training/pkg/grpcAutogenerated/training"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
	"google.golang.org/protobuf/types/known/emptypb"
)

type TestController struct {
	testService *services.TestService
	pb.UnimplementedTestServiceServer
}

func NewTestController(testService *services.TestService) *TestController {
	return &TestController{testService: testService}
}

func (c *TestController) GetTestList(ctx context.Context, in *pb.GetTestListRequest) (*pb.TestPreviewList, error) {
	name := in.GetName()
	page := in.GetPage()
	limit := in.GetLimit()
	offset := (page - 1) * limit

	args := &db.GetPublicTestsParams{
		TestName:      name,
		RequestOffset: offset,
		RequestLimit:  limit,
	}

	testPreviewList, err := c.testService.GetTestList(ctx, args)
	if err != nil {
		return nil, err
	}

	return testPreviewList, nil
}

func (c *TestController) GetTestsAmountByUserId(ctx context.Context, in *pb.GetTestsAmountByUserIdRequest) (*pb.GetTestAmountByUserIdResponse, error) {
	userUuid := in.GetUserUuid()

	args := pgtype.UUID{Bytes: uuid.MustParse(userUuid), Valid: true}
	testAmountResponse, err := c.testService.GetTestsAmountByUserId(ctx, args)
	if err != nil {
		return nil, err
	}

	return testAmountResponse, nil
}

func (c *TestController) GetTestsByUserId(ctx context.Context, in *pb.GetTestsByUserIdRequest) (*pb.TestPreviewList, error) {
	ownerUuid := in.GetOwnerUuid()
	userUuid := in.GetUserUuid()

	args := &db.GetTestsByOwnerIdParams{
		OwnerUuid:      pgtype.UUID{Bytes: uuid.MustParse(ownerUuid), Valid: true},
		IncludePrivate: ownerUuid == userUuid,
	}

	testPreviewList, err := c.testService.GetTestsByUserId(ctx, args)
	if err != nil {
		return nil, err
	}

	return testPreviewList, nil
}

func (c *TestController) CreateTest(ctx context.Context, in *pb.CreateTestRequest) (*pb.Test, error) {
	name := in.GetName()
	description := in.GetDescription()
	isPrivate := in.GetIsPrivate()
	ownerUuid := in.GetOwnerUuid()

	args := &db.CreateTestParams{
		Name:        name,
		Description: description,
		IsPrivate:   isPrivate,
		OwnerUuid:   pgtype.UUID{Bytes: uuid.MustParse(ownerUuid), Valid: true},
	}
	test, err := c.testService.CreateTest(ctx, args)
	if err != nil {
		return &pb.Test{}, err
	}

	return test, nil
}

func (c *TestController) GetTestById(ctx context.Context, in *pb.GetTestByIdRequest) (*pb.Test, error) {
	testUuid := in.GetUuid()
	ownerUuid := in.GetOwnerUuid()

	args := &services.GetTestByIdParams{
		TestUuid: pgtype.UUID{Bytes: uuid.MustParse(testUuid), Valid: true},
		UserUuid: pgtype.UUID{Bytes: uuid.MustParse(ownerUuid), Valid: true},
	}
	test, err := c.testService.GetTestById(ctx, args)
	if err != nil {
		return nil, err
	}

	return test, nil
}

func (c *TestController) UpdateTest(ctx context.Context, in *pb.UpdateTestRequest) (*pb.Test, error) {
	testUuid := in.GetTestUuid()
	name := in.GetName()
	description := in.GetDescription()
	isPrivate := in.GetIsPrivate()
	userUuidRaw := in.GetUserUuid()

	args := &db.UpdateTestParams{
		Name:        pgtype.Text{String: name, Valid: in.Name != nil},
		Description: pgtype.Text{String: description, Valid: in.Description != nil},
		IsPrivate:   pgtype.Bool{Bool: isPrivate, Valid: in.IsPrivate != nil},
		TestUuid:    pgtype.UUID{Bytes: uuid.MustParse(testUuid), Valid: true},
	}

	userUuid := pgtype.UUID{Bytes: uuid.MustParse(userUuidRaw), Valid: true}

	test, err := c.testService.UpdateTest(
		ctx,
		args,
		userUuid,
	)
	if err != nil {
		return nil, err
	}

	return test, nil
}

func (c *TestController) DeleteTest(ctx context.Context, in *pb.DeleteTestRequest) (*emptypb.Empty, error) {
	testUuid := in.GetTestUuid()

	// TODO use userUuid for security (check relations)
	// wnerUuid := in.GetOwnerUuid()

	args := pgtype.UUID{Bytes: uuid.MustParse(testUuid), Valid: true}
	err := c.testService.DeleteTest(ctx, args)
	if err != nil {
		return &emptypb.Empty{}, err
	}

	return &emptypb.Empty{}, nil
}
