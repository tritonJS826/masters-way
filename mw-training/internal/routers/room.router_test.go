package routers

import (
	"context"
	openapiTraining "mw-training/apiAutogenerated/training"
	"mw-training/internal/auth"
	"mw-training/internal/config"
	db "mw-training/internal/db/sqlc"
	"mw-training/internal/openapi"
	"net/http"
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestGetRoomById(t *testing.T) {
	newConfig, err := config.LoadConfig("../../")
	if err != nil {
		t.Fatalf("Failed to load config: %v", err)
	}

	chatApi := openapi.MakeTrainingAPIClient(&newConfig)
	_, err = chatApi.DevAPI.DevResetDbGet(context.Background()).Execute()
	if err != nil {
		t.Fatalf("Failed to reset db: %v", err)
	}

	currentUserID := "d2cb5e1b-44df-48d3-b7a1-34f3d7a5b7e2"
	userID := "3d922e8a-5d58-4b82-9a3d-83e2e73b3f91"
	roomID := "78bdf878-3b83-4f97-8d2e-928c132a10cd"

	t.Run("should return private room by room id with messages and users", func(t *testing.T) {
		token, err := auth.GenerateTestJWT(newConfig.SecretSessionKey, currentUserID)
		if err != nil {
			t.Fatalf("Failed to generate JWT: %v", err)
		}

		ctx := context.WithValue(context.Background(), auth.ContextKeyAuthorization, "Bearer "+token)
		getRoomByIdResponse, response, err := chatApi.RoomAPI.GetRoomById(ctx, roomID).Execute()

		nullableName := openapiTraining.NullableString{}
		nullableName.Set(nil)
		expectedData := &openapiTraining.MwChatInternalSchemasRoomPopulatedResponse{
			RoomId:    roomID,
			Name:      nullableName,
			RoomType:  "private",
			IsBlocked: false,
			Users: []openapiTraining.MwChatInternalSchemasUserResponse{
				{
					UserId: currentUserID,
					Role:   "regular",
				},
				{
					UserId: userID,
					Role:   "regular",
				},
			},
			Messages: []openapiTraining.MwChatInternalSchemasMessageResponse{
				{
					MessageId:      "7939af01-e785-445d-b79d-70a433979c7b",
					OwnerId:        currentUserID,
					Message:        "Test message 1",
					MessageReaders: []openapiTraining.MwChatInternalSchemasMessageReader{},
				},
				{
					MessageId: "91be5d99-eddf-4949-bf15-b4cee3989fa6",
					OwnerId:   userID,
					Message:   "Test message 2",
					MessageReaders: []openapiTraining.MwChatInternalSchemasMessageReader{
						{
							UserId:   currentUserID,
							ReadDate: "2024-08-09T02:00:00.000Z",
						},
					},
				},
				{
					MessageId:      "88a6d503-a03b-412c-bfab-06649e49d62d",
					OwnerId:        currentUserID,
					Message:        "Test message 3",
					MessageReaders: []openapiTraining.MwChatInternalSchemasMessageReader{},
				},
				{
					MessageId: "6cea59ef-f0d4-4d8c-aa12-e48a746c93d0",
					OwnerId:   userID,
					Message:   "Test message 4",
					MessageReaders: []openapiTraining.MwChatInternalSchemasMessageReader{
						{
							UserId:   currentUserID,
							ReadDate: "2024-08-10T13:30:00.000Z",
						},
					},
				},
			},
		}

		assert.Equal(t, http.StatusOK, response.StatusCode)
		assert.Equal(t, expectedData, getRoomByIdResponse)
	})
}

func TestGetChatPreview(t *testing.T) {
	newConfig, err := config.LoadConfig("../../")
	if err != nil {
		t.Fatalf("Failed to load config: %v", err)
	}

	chatApi := openapi.MakeTrainingAPIClient(&newConfig)
	_, err = chatApi.DevAPI.DevResetDbGet(context.Background()).Execute()
	if err != nil {
		t.Fatalf("Failed to reset db: %v", err)
	}

	currentUserID := "d2cb5e1b-44df-48d3-b7a1-34f3d7a5b7e2"

	t.Run("should return chat preview with correct unread messages amount", func(t *testing.T) {
		token, err := auth.GenerateTestJWT(newConfig.SecretSessionKey, currentUserID)
		if err != nil {
			t.Fatalf("Failed to generate JWT: %v", err)
		}

		ctx := context.WithValue(context.Background(), auth.ContextKeyAuthorization, "Bearer "+token)
		getChatPreviewResponse, response, err := chatApi.RoomAPI.GetChatPreview(ctx).Execute()
		if err != nil {
			t.Fatalf("Failed to get chat preview: %v", err)
		}

		expectedData := openapiTraining.MwChatInternalSchemasGetChatPreviewResponse{
			UnreadMessagesAmount: 3,
		}

		assert.Equal(t, http.StatusOK, response.StatusCode)
		assert.Equal(t, expectedData.UnreadMessagesAmount, getChatPreviewResponse.UnreadMessagesAmount)
	})
}

func TestGetRooms(t *testing.T) {
	newConfig, err := config.LoadConfig("../../")
	if err != nil {
		t.Fatalf("Failed to load config: %v", err)
	}

	chatApi := openapi.MakeTrainingAPIClient(&newConfig)
	_, err = chatApi.DevAPI.DevResetDbGet(context.Background()).Execute()
	if err != nil {
		t.Fatalf("Failed to reset db: %v", err)
	}

	roomCreatorID := "d63d2f89-6412-4324-8587-7061bf02dca4"

	t.Run("should return list of private rooms successfully", func(t *testing.T) {
		token, err := auth.GenerateTestJWT(newConfig.SecretSessionKey, roomCreatorID)
		if err != nil {
			t.Fatalf("Failed to generate JWT: %v", err)
		}

		ctx := context.WithValue(context.Background(), auth.ContextKeyAuthorization, "Bearer "+token)
		getRoomsResponse, response, err := chatApi.RoomAPI.GetRooms(ctx, "private").Execute()
		if err != nil {
			t.Fatalf("Failed to get chat preview: %v", err)
		}

		nullableName := openapiTraining.NullableString{}
		nullableName.Set(nil)
		expectedData := &openapiTraining.MwChatInternalSchemasGetRoomsResponse{
			Size: 3,
			Rooms: []openapiTraining.MwChatInternalSchemasRoomPreviewResponse{
				{
					RoomId:    "85f610df-9f86-4c55-8ee1-02485d42defb",
					Name:      nullableName,
					RoomType:  string(db.RoomTypePrivate),
					IsBlocked: false,
					Users: []openapiTraining.MwChatInternalSchemasUserResponse{
						{
							UserId: roomCreatorID,
							Role:   "regular",
						},
						{
							UserId: "8a3d1fe1-42da-499a-bf64-248297fd670a",
							Role:   "regular",
						},
					},
				},
				{
					RoomId:    "897f4a0f-fe31-4036-8358-f89a19c9bda6",
					Name:      nullableName,
					RoomType:  string(db.RoomTypePrivate),
					IsBlocked: false,
					Users: []openapiTraining.MwChatInternalSchemasUserResponse{
						{
							UserId: roomCreatorID,
							Role:   "regular",
						},
						{
							UserId: "5a31e3cb-7e9a-41e5-9a3b-1f1e5d6b7c3e",
							Role:   "regular",
						},
					},
				},
				{
					RoomId:    "e57fc491-69f7-4b30-9979-78879c8873bf",
					Name:      nullableName,
					RoomType:  string(db.RoomTypePrivate),
					IsBlocked: false,
					Users: []openapiTraining.MwChatInternalSchemasUserResponse{
						{
							UserId: roomCreatorID,
							Role:   "regular",
						},
						{
							UserId: "c31384a6-b811-4a1f-befa-95dd53e3f4b9",
							Role:   "regular",
						},
					},
				},
			},
		}

		assert.Equal(t, http.StatusOK, response.StatusCode)
		assert.Equal(t, expectedData, getRoomsResponse)
	})
}

func TestCreateRoom(t *testing.T) {
	newConfig, err := config.LoadConfig("../../")
	if err != nil {
		t.Fatalf("Failed to load config: %v", err)
	}

	chatApi := openapi.MakeTrainingAPIClient(&newConfig)
	_, err = chatApi.DevAPI.DevResetDbGet(context.Background()).Execute()
	if err != nil {
		t.Fatalf("Failed to reset db: %v", err)
	}

	roomCreatorID := "5bee7465-220d-40e7-82d7-b9b607fff21c"
	userID := "f4cbdb32-0fc0-4704-a6d9-9cf357e5cd3e"

	token, err := auth.GenerateTestJWT(newConfig.SecretSessionKey, roomCreatorID)
	if err != nil {
		t.Fatalf("Failed to generate JWT: %v", err)
	}

	var userIDNullableString = openapiTraining.NullableString{}
	userIDNullableString.Set(&userID)

	request := openapiTraining.MwChatInternalSchemasCreateRoomPayload{
		Name:     openapiTraining.NullableString{},
		RoomType: "private",
		UserId:   userIDNullableString,
	}

	t.Run("should create a private room and return it successfully", func(t *testing.T) {
		ctx := context.WithValue(context.Background(), auth.ContextKeyAuthorization, "Bearer "+token)
		findOrCreateRoomResponse, response, err := chatApi.RoomAPI.FindOrCreateRoom(ctx).Request(request).Execute()
		if err != nil {
			t.Fatalf("Failed to get private room: %v", err)
		}

		nullableName := openapiTraining.NullableString{}
		nullableName.Set(nil)
		expectedData := openapiTraining.MwChatInternalSchemasFindOrCreateRoomResponse{
			Room: openapiTraining.MwChatInternalSchemasRoomPopulatedResponse{
				RoomType: string(db.RoomTypePrivate),
				Users: []openapiTraining.MwChatInternalSchemasUserResponse{
					{
						UserId: roomCreatorID,
						Role:   "regular",
					},
					{
						UserId: userID,
						Role:   "regular",
					},
				},
				Name:      nullableName,
				Messages:  []openapiTraining.MwChatInternalSchemasMessageResponse{},
				IsBlocked: false,
			},
			IsAlreadyCreated: false,
		}

		assert.Equal(t, http.StatusOK, response.StatusCode)

		assert.Equal(t, expectedData.Room.RoomType, findOrCreateRoomResponse.Room.RoomType)
		assert.Equal(t, expectedData.Room.Users, findOrCreateRoomResponse.Room.Users)
		assert.Equal(t, expectedData.Room.Name, findOrCreateRoomResponse.Room.Name)
		assert.Equal(t, expectedData.Room.Messages, findOrCreateRoomResponse.Room.Messages)
		assert.Equal(t, expectedData.Room.IsBlocked, findOrCreateRoomResponse.Room.IsBlocked)

		assert.Equal(t, expectedData.IsAlreadyCreated, findOrCreateRoomResponse.IsAlreadyCreated)
	})
}
