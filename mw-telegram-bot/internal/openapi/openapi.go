package openapi

import (
	openapiGeneral "mw-telegram-bot/apiAutogenerated/general"
	"mw-telegram-bot/internal/config"
	"net/http"
)

type authTransport struct {
	rt http.RoundTripper
}

func (t *authTransport) RoundTrip(req *http.Request) (*http.Response, error) {
	token := UserToken
	if token == "" {
		token = SecretSessionKey
	}
	req.Header.Set("Authorization", "Bearer "+token)
	return t.rt.RoundTrip(req)
}

var SecretSessionKey string
var UserToken string

func MakeGeneralAPIClient(cfg *config.Config) *openapiGeneral.APIClient {
	generalAPIConfig := &openapiGeneral.Configuration{
		Host:   cfg.GeneralBFFAPIHost,
		Scheme: "http",
		Servers: openapiGeneral.ServerConfigurations{
			{
				URL:         cfg.GeneralBFFBaseURL,
				Description: "mw-general-bff",
			},
		},
		HTTPClient: &http.Client{
			Transport: &authTransport{rt: http.DefaultTransport},
		},
	}
	return openapiGeneral.NewAPIClient(generalAPIConfig)
}

func UpdateUserToken(token string) {
	UserToken = token
}
