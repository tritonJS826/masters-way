import {SchemasWayPopulatedResponse} from "src/apiAutogenerated";
import {DayReportDTOToDayReport} from "src/dataAccessLogic/DTOToPreviewConverter/dayReportDTOToDayReport";
import {getWayStatus} from "src/logic/waysTable/wayStatus";
import {Metric} from "src/model/businessModel/Metric";
import {Way} from "src/model/businessModel/Way";
import {UserPreview} from "src/model/businessModelPreview/UserPreview";
import {UserPreviewShort} from "src/model/businessModelPreview/UserPreviewShort";
import {arrayToHashMap} from "src/utils/arrayToHashMap";

/**
 * Convert {@link SchemasWayPopulatedResponse} to {@link Way}
 */
export const wayDTOToWay = (wayDTO: SchemasWayPopulatedResponse): Way => {
  const status = getWayStatus({
    status: wayDTO.isCompleted ? "Completed" : null,
    lastUpdate: new Date(wayDTO.updatedAt),
  });

  const owner = new UserPreviewShort({
    ...wayDTO.owner,
    createdAt: new Date(wayDTO.owner.createdAt),
  });

  const mentors = wayDTO.mentors.map((mentor) => new UserPreview({
    ...mentor,
    customWayCollections: [],
    favoriteForUserUuids: [],
    favoriteUserUuids: [],
    tags: [],
    wayRequests: [],
    createdAt: new Date(mentor.createdAt),
    imageUrl: mentor.imageUrl ?? "",
  }));

  const formerMentors = wayDTO.formerMentors.map((formerMentor) => new UserPreview({
    ...formerMentor,
    customWayCollections: [],
    favoriteForUserUuids: [],
    favoriteUserUuids: [],
    tags: [],
    wayRequests: [],
    createdAt: new Date(formerMentor.createdAt),
    imageUrl: formerMentor.imageUrl ?? "",
  }));

  return new Way({
    ...wayDTO,
    metrics: wayDTO.metrics.map((metric) => {
      return new Metric({
        ...metric,
        doneDate: metric.doneDate ? new Date(metric.doneDate) : null,
        createdAt: new Date(metric.createdAt),
      });
    }),
    status,
    favoriteForUsersAmount: wayDTO.favoriteForUsersAmount,
    mentorRequests: wayDTO.mentorRequests.map((mentorRequest) => new UserPreview({
      ...mentorRequest,
      customWayCollections: [],
      favoriteForUserUuids: [],
      favoriteUserUuids: [],
      tags: [],
      wayRequests: [],
      createdAt: new Date(mentorRequest.createdAt),
      imageUrl: mentorRequest.imageUrl ?? "",
    })),
    mentors: arrayToHashMap({keyField: "uuid", list: mentors}),
    formerMentors: arrayToHashMap({keyField: "uuid", list: formerMentors}),
    dayReports: wayDTO.dayReports.map(dayReport => DayReportDTOToDayReport({
      dayReportDTO: dayReport,
      wayName: wayDTO.name,
      wayUuid: wayDTO.uuid,
    })),
    createdAt: new Date(wayDTO.createdAt),
    lastUpdate: new Date(wayDTO.updatedAt),
    owner,
    children: wayDTO.children.map(wayDTOToWay),
  });
};
