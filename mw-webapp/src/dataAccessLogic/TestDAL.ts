import {testToTestDTOPartial} from "src/dataAccessLogic/BusinessToDTOConverter/testToTestDTOPartial";
import {testDTOToTest} from "src/dataAccessLogic/DTOToPreviewConverter/testDTOToTest";
import {testPreviewDTOToTestPreview} from "src/dataAccessLogic/DTOToPreviewConverter/testPreviewDTOToTestPreview";
import {GetTestsByUserIdParams} from "src/logic/userPage/testTab/TestTabStore";
import {Test} from "src/model/businessModel/Test";
import {TestPreview} from "src/model/businessModelPreview/TestPreview";
import {TestService} from "src/service/TestService";
import {TrainingService} from "src/service/TrainingService";
import {PartialWithUuid} from "src/utils/PartialWithUuid";

/**
 * All tests params
 */
export interface AllTestsParams {

  /**
   * Tests amount
   */
  size: number;

  /**
   * Array of tests preview
   */
  testsPreview: TestPreview[];
}

/**
 * All tests by user params
 */
export interface AllTestsByUserParams {

  /**
   * Tests amount
   */
  size: number;

  /**
   * Array of tests preview
   */
  testsPreview: TestPreview[];

  /**
   * Tests amount for each collection
   */
  testsAmount: TestsAmount;
}

/**
 * Pagination and filter params
 */
export interface GetTestsParams {

  /**
   * Page
   */
  page?: number;

  /**
   * Limit
   */
  limit?: number;

  /**
   * Part of test name
   */
  testName: string;

}

/**
 * Create Test params
 */
export interface CreateTestParams {

  /**
   * Owner's uuid
   */
  ownerUuid: string;

  /**
   * If true - test is private
   */
  isPrivate: boolean;

  /**
   * Project's name
   */
  name: string;

  /**
   * Training's name
   */
  description: string;

}

/**
 * Tests amount
 */
export interface TestsAmount {

  /**
   * Tests amount for owner collection
   */
  own: number;

  /**
   * Tests amount for passed collection
   */
  completed: number;
}

/**
 * Provides methods to interact with the Test model
 */
export class TestDAL {

  /**
   * Create Test with autogenerated uuid
   */
  public static async createTest(params: CreateTestParams): Promise<Test> {
    const testDTO = await TestService.createTest({
      request: {
        ownerUuid: params.ownerUuid,
        name: params.name,
        description: params.description,
        isPrivate: params.isPrivate,
      },
    });

    const test = testDTOToTest(testDTO);

    return test;
  }

  /**
   * Get all TestsPreview
   */
  public static async getTests(params?: GetTestsParams): Promise<AllTestsParams> {
    const testsPreviewDTO = await TestService.getAllTests(params);

    const testsPreview = testsPreviewDTO.testsList.map(testPreviewDTOToTestPreview);

    const tests = {
      size: testsPreviewDTO.size,
      testsPreview,
    };

    return tests;

  }

  /**
   * Get all user's tests by user Id
   */
  public static async getTestsByUserId(params: GetTestsByUserIdParams): Promise<AllTestsByUserParams> {
    const testsPreviewDTO = await TestService.getTestsByUserUuid({
      userId: params.userId,
      type: params.testsType,
    });
    const testsPreview = testsPreviewDTO.testsList.map(testPreviewDTOToTestPreview);

    const allTestsAmount = await TestService.getTestsAmountByUser({userId: params.userId});

    const tests = {
      size: testsPreviewDTO.size,
      testsPreview,
      testsAmount: allTestsAmount,
    };

    return tests;
  }

  /**
   * Get Test by Uuid
   */
  public static async getTest(testId: string): Promise<Test> {
    const testDTO = await TestService.getTestById({testId});
    const test = testDTOToTest(testDTO);

    return test;
  }

  /**
   * Update Test
   */
  public static async updateTest(test: PartialWithUuid<Test>) {
    const testDTOPartial = testToTestDTOPartial(test);
    await TestService.updateTest({
      testId: test.uuid,
      request: testDTOPartial,
    });
  }

  /**
   * Delete Test
   */
  public static async deleteTest(testId: string) {
    await TrainingService.deleteTraining({trainingId: testId});
  }

}
