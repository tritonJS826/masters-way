import {
  AuthApi,
  CommentApi,
  CompositeWayApi,
  Configuration,
  DayReportApi,
  FavoriteUserApi,
  FavoriteUserWayApi,
  FetchParams,
  FromUserMentoringRequestApi,
  JobDoneApi,
  JobDoneJobTagApi,
  JobTagApi,
  MentorUserWayApi,
  MetricApi,
  Middleware,
  PlanApi,
  PlanJobTagApi,
  ProblemApi,
  ProblemJobTagApi,
  RequestContext,
  ResponseContext,
  ToUserMentoringRequestApi,
  UserApi, UserTagApi,
  WayApi,
  WayCollectionApi,
  WayCollectionWayApi,
  WayTagApi,
} from "src/apiAutogenerated";
import {tokenStore} from "src/globalStore/TokenStore";
import {userStore} from "src/globalStore/UserStore";
import {env} from "src/utils/env/env";

/**
 * Access token provider
 */
const accessTokenProvider = () => tokenStore.accessToken ?? "";

const NOT_AUTHORIZED_STATUS = 401;

/**
 * Middleware to help refresh token
 */
const checkAuthMiddleware: Middleware = {

  /**
   * Pre request middle ware
   * @param context
   */
  pre: async (context: RequestContext): Promise<FetchParams | void> => {
    // Retrieve the access token
    const token = tokenStore.accessToken;

    // If a token exists, add it to the Authorization header
    if (token) {
      context.init.headers = {
        ...context.init.headers,
        "Authorization": `Bearer ${token}`,
      };
    }

    return Promise.resolve(context);
  },

  /**
   * Post request middleware
   */
  post: (context: ResponseContext): Promise<Response | void> => {
    if (context.response.status === NOT_AUTHORIZED_STATUS) {
      tokenStore.setAccessToken(null);
      userStore.clearUser();
    }

    return Promise.resolve(undefined);
  },
};

const configuration = new Configuration({
  basePath: env.API_BASE_PATH,
  credentials: "include",
  middleware: [checkAuthMiddleware],
  accessToken: accessTokenProvider,
});

export const authService = new AuthApi(configuration);
export const userService = new UserApi(configuration);
export const wayCollectionService = new WayCollectionApi(configuration);
export const favoriteUserService = new FavoriteUserApi(configuration);
export const userTagService = new UserTagApi(configuration);
export const wayTagService = new WayTagApi(configuration);
export const wayCollectionWayService = new WayCollectionWayApi(configuration);
export const wayService = new WayApi(configuration);
export const toUserMentoringRequestService = new ToUserMentoringRequestApi(configuration);
export const problemJobTagService = new ProblemJobTagApi(configuration);
export const planJobTagService = new PlanJobTagApi(configuration);
export const jobDoneJobTagService = new JobDoneJobTagApi(configuration);
export const jobTagService = new JobTagApi(configuration);
export const jobDoneService = new JobDoneApi(configuration);
export const planService = new PlanApi(configuration);
export const problemService = new ProblemApi(configuration);
export const commentService = new CommentApi(configuration);
export const dayReportService = new DayReportApi(configuration);
export const metricService = new MetricApi(configuration);
export const favoriteUserWayService = new FavoriteUserWayApi(configuration);
export const fromUserMentoringRequest = new FromUserMentoringRequestApi(configuration);
export const mentorUserWay = new MentorUserWayApi(configuration);
export const compositeWayService = new CompositeWayApi(configuration);
