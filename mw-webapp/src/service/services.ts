import {Configuration as ChatConfiguration, FileApi, MessageApi, RoomApi} from "src/apiAutogenerated/chat";
import {
  AuthApi,
  CommentApi,
  CompositeWayApi,
  Configuration as GeneralConfiguration,
  DayReportApi,
  FavoriteUserApi,
  FavoriteUserWayApi,
  FetchParams,
  FromUserMentoringRequestApi,
  GeminiApi,
  HealthApi,
  JobDoneApi,
  JobDoneJobTagApi,
  JobTagApi,
  MentorUserWayApi,
  MetricApi,
  Middleware,
  PlanApi,
  PlanJobTagApi,
  ProblemApi,
  ProjectApi,
  QuestionResultApi as AiQuestionResultApi,
  RequestContext,
  ResponseContext,
  ToUserMentoringRequestApi,
  UserApi, UserContactApi,
  UserContactUserApi,
  UserProjectApi,
  UserTagApi,
  WayApi,
  WayCollectionApi,
  WayCollectionWayApi,
  WayTagApi,
} from "src/apiAutogenerated/general";
import {
  Configuration as NotificationConfiguration,
  NotificationApi,
  NotificationSettingApi,
} from "src/apiAutogenerated/notification";
import {Configuration as SurveyConfiguration, SurveyApi} from "src/apiAutogenerated/survey";
import {
  Configuration as TestWebsocketConfiguration,
  SocketApi as TestWebsocketApi,
} from "src/apiAutogenerated/testWebsocket";
import {
  Configuration as TrainingConfiguration,
  FavoriteUserTrainingApi,
  PracticeMaterialApi,
  QuestionApi,
  QuestionResultApi,
  SessionsApi,
  TestApi,
  TestSessionResultApi,
  TheoryMaterialApi,
  TopicApi,
  TrainingApi,
  TrainingMentorApi,
  TrainingStudentApi,
  TrainingTestsApi,
  TrainingTrainingTagApi,
} from "src/apiAutogenerated/training";
import {AuthDAL} from "src/dataAccessLogic/AuthDAL";
import {tokenStore} from "src/globalStore/TokenStore";
import {userStore} from "src/globalStore/UserStore";
import {env} from "src/utils/env/env";

/**
 * Access token provider
 */
const accessTokenProvider = () => tokenStore.accessToken ?? "";

const NOT_AUTHORIZED_STATUS = 401;

/**
 * Reset all auth data
 */
export function resetAuthData() {
  tokenStore.resetTokens();
  userStore.clearUser();
}

/**
 * Middleware to help refresh token
 */
const checkAuthMiddleware: Middleware = {

  /**
   * Pre request middle ware
   * @param context
   */
  pre: async (context: RequestContext): Promise<FetchParams | void> => {
    // Retrieve the access token
    const token = tokenStore.accessToken;

    // If a token exists, add it to the Authorization header
    if (token) {
      context.init.headers = {
        ...context.init.headers,
        "Authorization": `Bearer ${token}`,
      };
    }

    return Promise.resolve(context);
  },

  /**
   * Post request middleware
   */
  post: async (context: ResponseContext): Promise<Response | void> => {
    try {
      if (context.response.status === NOT_AUTHORIZED_STATUS) {
        if (!tokenStore.refreshToken) {
          throw new Error("No refresh token on the client - cant refresh");
        }

        await AuthDAL.refreshToken(tokenStore.refreshToken);
        const originalRequest = context.response.url;
        const originalRequestOptions = {
          method: context.init.method,
          headers: {
            ...context.init.headers,
            Authorization: `Bearer ${tokenStore.accessToken}`,
          },
          body: context.init.body,
        };

        const response = await fetch(originalRequest, originalRequestOptions);

        return response;
      }
    } catch (e) {
      resetAuthData();
    }

    return Promise.resolve(undefined);
  },
};

const generalConfiguration = new GeneralConfiguration({
  basePath: env.API_BASE_PATH,
  credentials: "include",
  middleware: [checkAuthMiddleware],
  accessToken: accessTokenProvider,
});

export const healthCheckService = new HealthApi(generalConfiguration);
export const authService = new AuthApi(generalConfiguration);
export const userService = new UserApi(generalConfiguration);
export const wayCollectionService = new WayCollectionApi(generalConfiguration);
export const favoriteUserService = new FavoriteUserApi(generalConfiguration);
export const skillService = new UserTagApi(generalConfiguration);
export const createContactService = new UserContactUserApi(generalConfiguration);
export const updateDeleteContactService = new UserContactApi(generalConfiguration);
export const wayTagService = new WayTagApi(generalConfiguration);
export const wayCollectionWayService = new WayCollectionWayApi(generalConfiguration);
export const wayService = new WayApi(generalConfiguration);
export const toUserMentoringRequestService = new ToUserMentoringRequestApi(generalConfiguration);
export const planLabelService = new PlanJobTagApi(generalConfiguration);
export const jobDoneLabelService = new JobDoneJobTagApi(generalConfiguration);
export const labelService = new JobTagApi(generalConfiguration);
export const jobDoneService = new JobDoneApi(generalConfiguration);
export const planService = new PlanApi(generalConfiguration);
export const problemService = new ProblemApi(generalConfiguration);
export const commentService = new CommentApi(generalConfiguration);
export const dayReportService = new DayReportApi(generalConfiguration);
export const metricService = new MetricApi(generalConfiguration);
export const favoriteUserWayService = new FavoriteUserWayApi(generalConfiguration);
export const fromUserMentoringRequest = new FromUserMentoringRequestApi(generalConfiguration);
export const mentorUserWay = new MentorUserWayApi(generalConfiguration);
export const compositeWayService = new CompositeWayApi(generalConfiguration);
export const aiService = new GeminiApi(generalConfiguration);
export const aiQuestionResultService = new AiQuestionResultApi(generalConfiguration);
export const projectService = new ProjectApi(generalConfiguration);
export const userProjectService = new UserProjectApi(generalConfiguration);

const chatConfiguration = new ChatConfiguration({
  basePath: env.API_CHAT_BASE_PATH,
  credentials: "include",
  middleware: [checkAuthMiddleware],
  accessToken: accessTokenProvider,
});

export const chat = new RoomApi(chatConfiguration);
export const messageService = new MessageApi(chatConfiguration);
export const fileService = new FileApi(chatConfiguration);

const surveyConfiguration = new SurveyConfiguration({
  basePath: env.API_SURVEY_BASE_PATH,
  credentials: "include",
  middleware: [checkAuthMiddleware],
  accessToken: accessTokenProvider,
});

export const surveyService = new SurveyApi(surveyConfiguration);

const notificationConfiguration = new NotificationConfiguration({
  basePath: env.API_NOTIFICATION_BASE_PATH,
  credentials: "include",
  middleware: [checkAuthMiddleware],
  accessToken: accessTokenProvider,
});

export const notificationService = new NotificationApi(notificationConfiguration);
export const enabledNotificationService = new NotificationSettingApi(notificationConfiguration);

const trainingConfiguration = new TrainingConfiguration({
  basePath: env.API_TRAINING_BASE_PATH,
  credentials: "include",
  middleware: [checkAuthMiddleware],
  accessToken: accessTokenProvider,
});

export const trainingService = new TrainingApi(trainingConfiguration);
export const topicService = new TopicApi(trainingConfiguration);
export const trainingMentorService = new TrainingMentorApi(trainingConfiguration);
export const trainingStudentService = new TrainingStudentApi(trainingConfiguration);
export const trainingTrainingTagService = new TrainingTrainingTagApi(trainingConfiguration);
export const favoriteUserTrainingService = new FavoriteUserTrainingApi(trainingConfiguration);
export const practiceMaterialService = new PracticeMaterialApi(trainingConfiguration);
export const theoryMaterialService = new TheoryMaterialApi(trainingConfiguration);
export const testService = new TestApi(trainingConfiguration);
export const questionResultService = new QuestionResultApi(trainingConfiguration);
export const questionService = new QuestionApi(trainingConfiguration);
export const sessionService = new SessionsApi(trainingConfiguration);
export const testSessionResultService = new TestSessionResultApi(trainingConfiguration);
export const trainingTestService = new TrainingTestsApi(trainingConfiguration);

const testWebsocketConfiguration = new TestWebsocketConfiguration({
  basePath: env.API_MW_TEST_WEBSOCKET_REST_PATH,
  credentials: "include",
  middleware: [checkAuthMiddleware],
  accessToken: accessTokenProvider,
});

export const testWebsocketService = new TestWebsocketApi(testWebsocketConfiguration);
