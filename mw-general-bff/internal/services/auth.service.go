package services

import (
	"context"
	"fmt"
	openapiGeneral "mw-general-bff/apiAutogenerated/general"
	"mw-general-bff/pkg/utils"

	"golang.org/x/oauth2"
	oauthGoogle "google.golang.org/api/oauth2/v2"
)

type AuthService struct {
	generalAPI *openapiGeneral.APIClient
}

func newAuthService(generalAPI *openapiGeneral.APIClient) *AuthService {
	return &AuthService{generalAPI}
}

type GoogleAuthInfo struct {
	UserInfo *oauthGoogle.Userinfo
	Token    *oauth2.Token
}

func (as *AuthService) AuthenticateGoogleUser(ctx context.Context, code, state string) (*GoogleAuthInfo, error) {
	// token, err := as.googleOAuthConfig.Exchange(ctx, code)
	// if err != nil {
	// 	return nil, err
	// }

	// client := as.googleOAuthConfig.Client(ctx, token)

	// oauth2Service, err := oauthGoogle.NewService(ctx, option.WithHTTPClient(client))
	// if err != nil {
	// 	return nil, err
	// }

	// userInfo, err := oauth2Service.Userinfo.Get().Do()
	// if err != nil {
	// 	return nil, err
	// }

	// return &GoogleAuthInfo{
	// 	UserInfo: userInfo,
	// 	Token:    token,
	// }, nil
	return nil, nil
}

func (as *AuthService) GetUserTokenByEmail() {
}

func (as *AuthService) GetGoogleAuthURL() string {
	return ""
}

func (as *AuthService) SetGoogleAccessTokenByUserID(userID, token string) {
}

func (as *AuthService) GetGoogleAccessTokenByUserID(userID string) (string, error) {
	return "", nil
}

func (as *AuthService) GetCurrentAuthorizedUserByToken(ctx context.Context) (*openapiGeneral.SchemasUserPopulatedResponse, error) {
	userPopulated, response, err := as.generalAPI.AuthAPI.GetCurrentAuthorizedUser(ctx).Execute()

	if err != nil {
		message, extractErr := utils.ExtractErrorMessageFromResponse(response)
		if extractErr != nil {
			return nil, fmt.Errorf("failed to extract error message: %w", extractErr)
		}
		return nil, fmt.Errorf(message)
	}

	return userPopulated, nil
}
