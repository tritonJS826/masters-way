package services

import (
	"context"
	openapiGeneral "mw-general-bff/apiAutogenerated/general"
	"mw-general-bff/pkg/utils"

	"golang.org/x/oauth2"
	oauthGoogle "google.golang.org/api/oauth2/v2"
)

type AuthService struct {
	generalAPI *openapiGeneral.APIClient
}

func newAuthService(generalAPI *openapiGeneral.APIClient) *AuthService {
	return &AuthService{generalAPI}
}

type GoogleAuthInfo struct {
	UserInfo *oauthGoogle.Userinfo
	Token    *oauth2.Token
}

func (as *AuthService) GetAuthCallbackFunction(ctx context.Context, provider, code, state string) (*openapiGeneral.MwServerInternalSchemasGetAuthCallbackFunctionResponse, error) {
	authCallbackFunctionResponse, response, err := as.generalAPI.AuthAPI.GoogleAuthLogInCallbackFunction(ctx, provider).Code(code).State(state).Execute()
	if err != nil {
		return nil, utils.ExtractErrorMessageFromResponse(response)
	}
	return authCallbackFunctionResponse, nil
}

func (as *AuthService) GetUserTokenByEmail(ctx context.Context, email string) (*openapiGeneral.MwServerInternalSchemasGetAuthCallbackFunctionResponse, error) {
	authCallbackFunctionResponse, response, err := as.generalAPI.AuthAPI.GetTokenLocally(ctx, email).Execute()
	if err != nil {
		return nil, utils.ExtractErrorMessageFromResponse(response)
	}
	return authCallbackFunctionResponse, nil
}

func (as *AuthService) GetGoogleAuthURL(ctx context.Context, provider string) (*openapiGeneral.MwServerInternalSchemasBeginAuthResponse, error) {
	beginAuthResponse, response, err := as.generalAPI.AuthAPI.BeginAuth(ctx, provider).Execute()
	if err != nil {
		return nil, utils.ExtractErrorMessageFromResponse(response)
	}
	return beginAuthResponse, nil
}

func (as *AuthService) GetGoogleAccessTokenByUserID(ctx context.Context) (*openapiGeneral.MwServerInternalSchemasGoogleToken, error) {
	googleToken, response, err := as.generalAPI.AuthAPI.GetGoogleToken(ctx).Execute()
	if err != nil {
		return nil, utils.ExtractErrorMessageFromResponse(response)
	}
	return googleToken, nil
}

func (as *AuthService) GetCurrentAuthorizedUserByToken(ctx context.Context) (*openapiGeneral.MwServerInternalSchemasCurrentUserResponse, error) {
	currentUser, response, err := as.generalAPI.AuthAPI.GetCurrentAuthorizedUser(ctx).Execute()
	if err != nil {
		return nil, utils.ExtractErrorMessageFromResponse(response)
	}
	return currentUser, nil
}

func (as *AuthService) Logout(ctx context.Context, provider string) error {
	_, err := as.generalAPI.AuthAPI.LogoutCurrentAuthorizedUser(ctx, provider).Execute()
	if err != nil {
		return err
	}
	return nil
}

func (as *AuthService) RefreshAccessToken(ctx context.Context, refreshToken string) (*openapiGeneral.MwServerInternalSchemasRefreshAccessTokenResponse, error) {
	params := openapiGeneral.MwServerInternalSchemasRefreshAccessTokenPayload{
		RefreshToken: refreshToken,
	}
	accessToken, response, err := as.generalAPI.AuthAPI.RefreshAccessToken(ctx).Request(params).Execute()
	if err != nil {
		return nil, utils.ExtractErrorMessageFromResponse(response)
	}
	return accessToken, nil
}
