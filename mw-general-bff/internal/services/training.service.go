package services

import (
	"context"
	pb "mw-general-bff/pkg/grpcAutoGenerated/training"

	"google.golang.org/protobuf/types/known/emptypb"
)

type TrainingService struct {
	trainingGRPC            pb.TrainingServiceClient
	testGRPC                pb.TestServiceClient
	questionGRPC            pb.QuestionServiceClient
	questionResultsGRPC     pb.QuestionResultsServiceClient
	testSessionResultGRPC   pb.TestSessionResultsServiceClient
	topicGRPC               pb.TopicsServiceClient
	theoryMaterialGRPC      pb.TheoryMaterialServiceClient
	practiceMaterialGRPC    pb.PracticeMaterialServiceClient
	trainingMessageToAiGRPC pb.TrainingMessageToAIServiceClient
}

func newTrainingService(
	trainingGRPC pb.TrainingServiceClient,
	testGRPC pb.TestServiceClient,
	questionGRPC pb.QuestionServiceClient,
	questionResultsGRPC pb.QuestionResultsServiceClient,
	testSessionResultGRPC pb.TestSessionResultsServiceClient,
	topicGRPC pb.TopicsServiceClient,
	theoryMaterialGRPC pb.TheoryMaterialServiceClient,
	practiceMaterialGRPC pb.PracticeMaterialServiceClient,
	trainingMessageToAiGRPC pb.TrainingMessageToAIServiceClient,
) *TrainingService {
	return &TrainingService{trainingGRPC, testGRPC, questionGRPC, questionResultsGRPC, testSessionResultGRPC, topicGRPC, theoryMaterialGRPC, practiceMaterialGRPC, trainingMessageToAiGRPC}
}

type GetTestParams struct {
	TestId string
	UserId string
}

func (ts *TrainingService) GetTestById(ctx context.Context, params *GetTestParams) (*pb.Test, error) {
	test, err := ts.testGRPC.GetTestById(ctx, &pb.GetTestByIdRequest{
		Uuid:      params.TestId,
		OwnerUuid: params.UserId,
	})
	if err != nil {
		return nil, err
	}
	return test, nil
}

type GetTestSessionResultParams struct {
	SessionUuid string
	UserUuid    string
}

func (ts *TrainingService) GetTestSessionResult(ctx context.Context, params *GetTestSessionResultParams) (*pb.GetTestSessionResultResponse, error) {
	testSessionResult, err := ts.testSessionResultGRPC.GetTestSessionResult(ctx, &pb.GetTestSessionResultRequest{
		SessionUuid: params.SessionUuid,
		UserUuid:    params.UserUuid,
	})
	if err != nil {
		return nil, err
	}
	return testSessionResult, nil
}

type GetQuestionByIdParams struct {
	QuestionUuid string
	UserUuid     string
}

func (ts *TrainingService) GetQuestionById(ctx context.Context, params *GetQuestionByIdParams) (*pb.Question, error) {
	question, err := ts.questionGRPC.GetQuestionById(ctx, &pb.GetQuestionByIdRequest{
		QuestionUuid: params.QuestionUuid,
		UserUuid:     params.UserUuid,
	})
	if err != nil {
		return nil, err
	}
	return question, nil
}

type GetQuestionResultsBySessionUuidParams struct {
	SessionUuid string
	UserUuid    string
}

func (ts *TrainingService) GetQuestionResultsBySessionUuid(ctx context.Context, params *GetQuestionResultsBySessionUuidParams) (*pb.GetQuestionResultsBySessionUuidResponse, error) {
	questionResult, err := ts.questionResultsGRPC.GetQuestionResultsBySessionUuid(ctx, &pb.GetQuestionResultsBySessionUuidRequest{
		SessionUuid: params.SessionUuid,
		UserUuid:    params.UserUuid,
	})
	if err != nil {
		return nil, err
	}
	return questionResult, nil
}

type CreateQuestionResultParams struct {
	QuestionUuid      string
	UserUuid          string
	TestUuid          string
	TestSessionUuid   string
	IsOk              bool
	ResultDescription string
	UserAnswer        string
}

func (ts *TrainingService) CreateQuestionResult(ctx context.Context, params *CreateQuestionResultParams) (*pb.QuestionResult, error) {
	questionResult, err := ts.questionResultsGRPC.CreateQuestionResult(ctx, &pb.CreateQuestionResultRequest{
		QuestionUuid:      params.QuestionUuid,
		UserUuid:          params.UserUuid,
		TestUuid:          params.TestUuid,
		TestSessionUuid:   params.TestSessionUuid,
		IsOk:              params.IsOk,
		ResultDescription: params.ResultDescription,
		UserAnswer:        params.UserAnswer,
	})
	if err != nil {
		return nil, err
	}
	return questionResult, nil
}

type CreateTestQuestionParams struct {
	TestUuid     string
	UserUuid     string
	Name         string
	QuestionText *string
	TimeToAnswer *int32
	Answer       *string
	PracticeType string
}

func (ts *TrainingService) CreateTestQuestion(ctx context.Context, params CreateTestQuestionParams) (*pb.Question, error) {
	question, err := ts.questionGRPC.CreateQuestion(ctx, &pb.CreateQuestionRequest{
		TestUuid:     params.TestUuid,
		UserUuid:     params.UserUuid,
		Name:         params.Name,
		QuestionText: params.QuestionText,
		TimeToAnswer: params.TimeToAnswer,
		Answer:       params.Answer,
		PracticeType: params.PracticeType,
	})
	if err != nil {
		return nil, err
	}
	return question, nil
}

func (ts *TrainingService) GetTrainingById(ctx context.Context, trainingId string) (*pb.Training, error) {
	training, err := ts.trainingGRPC.GetTrainingById(ctx, &pb.GetTrainingRequest{TrainingUuid: trainingId})
	if err != nil {
		return nil, err
	}
	return training, nil
}

type CreateNewTrainingParams struct {
	Name        string
	UserId      string
	Description string
	IsPrivate   bool
}

func (ts *TrainingService) CreateNewTraining(ctx context.Context, params *CreateNewTrainingParams) (*pb.Training, error) {
	training, err := ts.trainingGRPC.CreateNewTraining(ctx, &pb.CreateTrainingRequest{
		Name:        params.Name,
		UserId:      params.UserId,
		Description: params.Description,
		IsPrivate:   params.IsPrivate,
	})
	if err != nil {
		return nil, err
	}
	return training, nil
}

func (ts *TrainingService) GetTopicById(ctx context.Context, topicId string) (*pb.Topic, error) {
	topic, err := ts.topicGRPC.GetTopicById(ctx, &pb.GetTopicByIdRequest{TopicUuid: topicId})
	if err != nil {
		return nil, err
	}
	return topic, nil
}

type CreateTopicParams struct {
	TopicName    string
	TrainingUuid string
}

func (ts *TrainingService) CreateTopic(ctx context.Context, params *CreateTopicParams) (*pb.TopicPreview, error) {
	topic, err := ts.topicGRPC.CreateTopic(ctx, &pb.CreateTopicRequest{
		Name:         params.TopicName,
		TrainingUuid: params.TrainingUuid,
	})
	if err != nil {
		return nil, err
	}
	return topic, nil
}

type CreateTheoryMaterialPayload struct {
	TopicUuid   string `json:"topicUuid" validate:"required"`
	Name        string `json:"name" validate:"required"`
	Description string `json:"description" validate:"required"`
}

func (ts *TrainingService) CreateTheoryMaterial(ctx context.Context, params *CreateTheoryMaterialPayload) (*pb.TheoryMaterial, error) {
	theoryMaterialResponse, err := ts.theoryMaterialGRPC.CreateTheoryMaterial(ctx, &pb.CreateTheoryMaterialRequest{
		TopicUuid:   params.TopicUuid,
		Name:        params.Name,
		Description: params.Description,
	})
	if err != nil {
		return nil, err
	}
	return theoryMaterialResponse, nil
}

type CreatePracticeMaterialParams struct {
	TopicUuid    string `json:"topicUuid" validate:"required"`
	Name         string `json:"name" validate:"required"`
	Description  string `json:"description" validate:"required"`
	Answer       string `json:"answer" validate:"required"`
	PracticeType string `json:"practiceType" validate:"required"`
	TimeToAnswer int32  `json:"timeToAnswer" validate:"required"`
}

func (ts *TrainingService) CreatePracticeMaterial(ctx context.Context, params *CreatePracticeMaterialParams) (*pb.PracticeMaterial, error) {
	theoryMaterialResponse, err := ts.practiceMaterialGRPC.CreatePracticeMaterial(ctx, &pb.CreatePracticeMaterialRequest{
		TopicUuid:    params.TopicUuid,
		Name:         params.Name,
		Description:  params.Description,
		Answer:       params.Answer,
		PracticeType: params.PracticeType,
		TimeToAnswer: params.TimeToAnswer,
	})
	if err != nil {
		return nil, err
	}
	return theoryMaterialResponse, nil
}

func (ts *TrainingService) GetMessageToAI(ctx context.Context) (*pb.MessageToAI, error) {
	message, err := ts.trainingMessageToAiGRPC.GetMessageToAI(ctx, &emptypb.Empty{})
	if err != nil {
		return nil, err
	}
	return message, nil
}

func (ts *TrainingService) HandleResponseFromAiForItem(ctx context.Context, messageFromAi *pb.MessageFromAI) error {
	_, err := ts.trainingMessageToAiGRPC.HandleResponseFromAiForItem(ctx, messageFromAi)
	if err != nil {
		return err
	}
	return nil
}
