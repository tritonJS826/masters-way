package services

import (
	"context"
	"mw-general-bff/internal/schemas"
	pb "mw-general-bff/pkg/grpcAutoGenerated/notification"
)

type NotificationService struct {
	notificationGRPC        pb.NotificationServiceClient
	notificationSettingGRPC pb.NotificationSettingServiceClient
}

func newNotificationService(
	notificationGRPC pb.NotificationServiceClient,
	notificationSettingGRPC pb.NotificationSettingServiceClient,
) *NotificationService {
	return &NotificationService{notificationGRPC, notificationSettingGRPC}
}

type Nature string

const (
	PrivateChat      Nature = "private_chat"
	GroupChat        Nature = "group_chat"
	OwnWay           Nature = "own_way"
	MentoringWay     Nature = "mentoring_way"
	MentoringRequest Nature = "mentoring_request"
	FavoriteWay      Nature = "favorite_way"
)

type CreateNotificationsParams struct {
	UserUUIDs   []string
	Description string
	Url         string
	Nature      Nature
}

func (ns *NotificationService) CreateNotifications(ctx context.Context, params *CreateNotificationsParams) (*pb.CreateNotificationsResponse, error) {
	in := &pb.CreateNotificationRequest{
		UserUuids:   params.UserUUIDs,
		Description: params.Description,
		Url:         params.Url,
		Nature:      pb.Nature(pb.Nature_value[string(params.Nature)]),
	}

	createNotificationsResponseRaw, err := ns.notificationGRPC.CreateNotifications(ctx, in)
	if err != nil {
		return nil, err
	}

	return createNotificationsResponseRaw, nil

	// lo.Map(createNotificationsResponseRaw.CreateNotificationList, func(pbCreateNotificationResponse *pb.CreateNotificationResponse, _ int) schemas.CreateNotificationResponse {
	// 	lo.Map(createNotificationsResponseRaw.CreateNotificationList, func(pbCreateNotificationResponse *pb.CreateNotificationResponse, _ int) schemas.CreateNotificationResponse {
	// 	})
	// 	return schemas.CreateNotificationResponse{
	// 		Notification:            pbCreateNotificationResponse.Notification,
	// 		NotificationSettingList: []schemas.NotificationSettingResponse{},
	// 	}
	// })

	// &schemas.NotificationResponse{
	// UUID:        notification.Uuid,
	// UserUUID:    notification.UserUuid,
	// IsRead:      notification.IsRead,
	// Description: notification.Description,
	// Url:         notification.Url,
	// Nature:      notification.Nature.String(),
	// CreatedAt:   notification.CreatedAt,
	// }, nil
}

func (ns *NotificationService) CreateNotificationSettings(ctx context.Context, userUUID string) error {
	in := &pb.CreateNotificationSettingsRequest{
		UserUuid: userUUID,
	}

	_, err := ns.notificationSettingGRPC.CreateNotificationSettings(ctx, in)
	if err != nil {
		return err
	}

	return nil
}

func (ns *NotificationService) GetNotificationSettingList(ctx context.Context, userUUID string) ([]*schemas.NotificationSettingResponse, error) {
	in := &pb.GetNotificationSettingListRequest{
		UserUuid: userUUID,
	}

	settingList, err := ns.notificationSettingGRPC.GetNotificationSettingList(ctx, in)
	if err != nil {
		return nil, err
	}

	var response []*schemas.NotificationSettingResponse
	for _, setting := range settingList.NotificationSettings {
		response = append(response, &schemas.NotificationSettingResponse{
			UUID:      setting.Uuid,
			UserUUID:  setting.UserUuid,
			Nature:    setting.Nature.String(),
			Channel:   setting.Channel.String(),
			IsEnabled: setting.IsEnabled,
		})
	}

	return response, nil
}
