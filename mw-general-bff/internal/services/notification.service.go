package services

import (
	"context"
	"mw-general-bff/internal/schemas"
	pb "mw-general-bff/pkg/grpcAutoGenerated/notification"
)

type NotificationService struct {
	notificationGRPC        pb.NotificationClient
	enabledNotificationGRPC pb.EnabledNotificationClient
}

func NewNotificationService(
	notificationGRPC pb.NotificationClient,
	enabledNotificationGRPC pb.EnabledNotificationClient,
) *NotificationService {
	return &NotificationService{notificationGRPC, enabledNotificationGRPC}
}

type CreateNotificationsParams struct {
	UserUUID    string
	Description string
	Url         string
	Nature      string
}

func (ns *NotificationService) CreateNotifications(ctx context.Context, params *CreateNotificationsParams) (*schemas.NotificationResponse, error) {
	in := &pb.CreateNotificationRequest{
		UserUuid:    params.UserUUID,
		Description: params.Description,
		Url:         params.Url,
		Nature:      params.Nature,
	}

	notification, err := ns.notificationGRPC.CreateNotification(ctx, in)
	if err != nil {
		return nil, err
	}

	return &schemas.NotificationResponse{
		UUID:        notification.Uuid,
		UserUUID:    notification.UserUuid,
		IsRead:      notification.IsRead,
		Description: notification.Description,
		Url:         notification.Url,
		Nature:      notification.Nature,
		CreatedAt:   notification.CreatedAt,
	}, nil
}

func (ns *NotificationService) CreateEnabledNotifications(ctx context.Context, userUUID string) error {
	in := &pb.CreateEnabledNotificationsRequest{
		UserUuid: userUUID,
	}

	_, err := ns.enabledNotificationGRPC.CreateEnabledNotifications(ctx, in)
	if err != nil {
		return err
	}

	return nil
}
