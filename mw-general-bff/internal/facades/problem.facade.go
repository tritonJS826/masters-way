package facades

import (
	"context"
	webapprouter "go-common/webappRouter"
	openapiGeneral "mw-general-bff/apiAutogenerated/general"
	"mw-general-bff/internal/config"
	"mw-general-bff/internal/schemas"
	"mw-general-bff/internal/services"
)

type ProblemFacade struct {
	generalService      *services.GeneralService
	notificationService *services.NotificationService
	mailService         *services.MailService
	config              *config.Config
	router              *webapprouter.WebappRouter
}

func newProblemFacade(
	generalService *services.GeneralService,
	notificationService *services.NotificationService,
	mailService *services.MailService,
	config *config.Config,
) *ProblemFacade {
	router := webapprouter.NewWebappRouter(config.WebappBaseURL)
	return &ProblemFacade{generalService, notificationService, mailService, config, router}
}

func (pf *ProblemFacade) CreateProblem(ctx context.Context, payload *schemas.CreateProblemPayload) (*openapiGeneral.MwServerInternalSchemasProblemPopulatedResponse, error) {
	return pf.generalService.CreateProblem(ctx, payload)
}

func (pf *ProblemFacade) UpdateProblem(ctx context.Context, params *services.UpdateProblemParams) (*openapiGeneral.MwServerInternalSchemasProblemPopulatedResponse, error) {
	problem, err := pf.generalService.UpdateProblem(ctx, params)

	args := &NotifyWayUpdatedParams{
		generalService:      pf.generalService,
		notificationService: pf.notificationService,
		mailService:         pf.mailService,
		config:              pf.config,
		router:              pf.router,
		wayUuid:             problem.WayUuid,
		modifierUuid:        params.ModifierUserUuid,
	}
	NotifyWayUpdated(ctx, args)

	return problem, err
}

func (pf *ProblemFacade) DeleteProblemById(ctx context.Context, problemID string) error {
	return pf.generalService.DeleteProblemById(ctx, problemID)
}
