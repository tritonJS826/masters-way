package facades

import (
	"context"
	"fmt"
	openapiGeneral "mw-general-bff/apiAutogenerated/general"
	"mw-general-bff/internal/config"
	"mw-general-bff/internal/schemas"
	"mw-general-bff/internal/services"

	"github.com/samber/lo"
)

type JobDoneFacade struct {
	generalService      *services.GeneralService
	notificationService *services.NotificationService
	config              *config.Config
}

func newJobDoneFacade(
	generalService *services.GeneralService,
	notificationService *services.NotificationService,
	config *config.Config,
) *JobDoneFacade {
	return &JobDoneFacade{generalService, notificationService, config}
}

func (jf *JobDoneFacade) CreateJobDone(ctx context.Context, payload *schemas.CreateJobDonePayload) (*openapiGeneral.MwServerInternalSchemasJobDonePopulatedResponse, error) {
	return jf.generalService.CreateJobDone(ctx, payload)
}

func (jf *JobDoneFacade) UpdateJobDone(ctx context.Context, params *services.UpdateJobDoneParams) (*openapiGeneral.MwServerInternalSchemasJobDonePopulatedResponse, error) {
	jobDone, err := jf.generalService.UpdateJobDone(ctx, params)
	if err != nil {
		return nil, err
	}

	way, err := jf.generalService.GetWayPlainForNotificationById(ctx, jobDone.WayUuid)
	if err != nil {
		return nil, err
	}

	participants := append(way.Mentors, way.Owner)
	notificationReceivers := lo.FilterMap(participants, func(participant openapiGeneral.MwServerInternalSchemasUserPlainResponse, _ int) (string, bool) {
		isReceiver := jobDone.OwnerUuid != participant.Uuid
		return participant.Uuid, isReceiver
	})

	notificationResponse, err := jf.notificationService.CreateNotifications(ctx, &services.CreateNotificationsParams{
		UserUUIDs:   notificationReceivers,
		Description: "JobDone test notification",
		Url:         jf.config.WebappBaseURL + "/way/" + jobDone.WayUuid,
		Nature:      services.OwnWay,
	})
	if err != nil {
		return nil, err
	}

	for _, notificationResponse := range notificationResponse.CreateNotificationList {
		for _, notificationSetting := range notificationResponse.NotificationSettingList {
			// TODO: send notification to all channels
			// TODO: notificationSetting.Channel
			fmt.Println(notificationSetting)
			// fmt.Println(notificationResponse.Notification)
		}
	}

	return jobDone, nil
}

func (jf *JobDoneFacade) DeleteJobDoneByID(ctx context.Context, jobDoneID string) error {
	return jf.generalService.DeleteJobDoneByID(ctx, jobDoneID)
}
