package facades

import (
	"context"
	webapprouter "go-common/webappRouter"
	openapiGeneral "mw-general-bff/apiAutogenerated/general"
	"mw-general-bff/internal/config"
	"mw-general-bff/internal/schemas"
	"mw-general-bff/internal/services"
)

type PlanFacade struct {
	generalService      *services.GeneralService
	notificationService *services.NotificationService
	mailService         *services.MailService
	config              *config.Config
	router              *webapprouter.WebappRouter
}

func newPlanFacade(
	generalService *services.GeneralService,
	notificationService *services.NotificationService,
	mailService *services.MailService,
	config *config.Config,
) *PlanFacade {
	router := webapprouter.NewWebappRouter(config.WebappBaseURL)
	return &PlanFacade{generalService, notificationService, mailService, config, router}
}

func (pf *PlanFacade) CreatePlan(ctx context.Context, payload *schemas.CreatePlanPayload) (*openapiGeneral.MwServerInternalSchemasPlanPopulatedResponse, error) {
	return pf.generalService.CreatePlan(ctx, payload)
}

func (pf *PlanFacade) UpdatePlan(ctx context.Context, params *services.UpdatePlanParams) (*openapiGeneral.MwServerInternalSchemasPlanPopulatedResponse, error) {
	plan, err := pf.generalService.UpdatePlan(ctx, params)

	args := &NotifyWayUpdatedParams{
		generalService:      pf.generalService,
		notificationService: pf.notificationService,
		mailService:         pf.mailService,
		config:              pf.config,
		router:              pf.router,
		wayUuid:             plan.WayUuid,
		modifierUuid:        params.ModifierUserUuid,
	}
	NotifyWayUpdated(ctx, args)

	return plan, err
}

func (pf *PlanFacade) DeletePlanById(ctx context.Context, planID string) error {
	return pf.generalService.DeletePlanById(ctx, planID)
}
