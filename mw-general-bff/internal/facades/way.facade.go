package facades

import (
	"context"
	openapiGeneral "mw-general-bff/apiAutogenerated/general"
	"mw-general-bff/internal/schemas"
	"mw-general-bff/internal/services"
	pb "mw-general-bff/pkg/grpcAutoGenerated/training"

	"github.com/gin-gonic/gin"
	"github.com/samber/lo"
)

type WayFacade struct {
	generalService  *services.GeneralService
	trainingService *services.TrainingService
}

func newWayFacade(generalService *services.GeneralService, trainingService *services.TrainingService) *WayFacade {
	return &WayFacade{generalService, trainingService}
}

type CreateWayFromTrainingParams struct {
	OwnerId    string
	TrainingId string
}

func (wf *WayFacade) convertTopicTreeNode(ctx context.Context, node *pb.TopicTreeNode, wayId string, parentMetricId *string) *openapiGeneral.MwServerInternalSchemasMetricTreeNode {
	if node == nil {
		return nil
	}

	createMetricArgs := &schemas.CreateMetricPayload{
		WayUuid:          wayId,
		Description:      node.Topic.Name,
		IsDone:           false,
		MetricEstimation: 0,
		DoneDate:         nil,
		ParentUuid:       parentMetricId,
	}
	newMetric, _ := wf.generalService.CreateMetric(ctx, createMetricArgs)

	emptyChildren := make([]openapiGeneral.MwServerInternalSchemasMetricTreeNode, 0)
	newNode := &openapiGeneral.MwServerInternalSchemasMetricTreeNode{
		Metric: openapiGeneral.MwServerInternalSchemasMetricResponse{
			Description:    newMetric.Description,
			DoneDate:       newMetric.DoneDate,
			EstimationTime: newMetric.EstimationTime,
			IsDone:         newMetric.IsDone,
			ParentUuid:     newMetric.ParentUuid,
			Uuid:           newMetric.Uuid,
		},
		Children: emptyChildren,
	}

	for _, child := range node.Children {
		newChild := wf.convertTopicTreeNode(ctx, child, wayId, &newMetric.Uuid)
		newNode.Children = append(newNode.Children, *newChild)
	}

	return newNode
}

func (wf *WayFacade) CreateWayFromTraining(ctx context.Context, params *CreateWayFromTrainingParams) (*openapiGeneral.MwServerInternalSchemasWayPopulatedResponse, error) {
	training, err := wf.trainingService.GetTrainingById(ctx, params.TrainingId)
	if err != nil {
		return nil, err
	}

	way, err := wf.generalService.CreateWay(ctx, &schemas.CreateWayPayload{
		Name:            training.Name,
		GoalDescription: training.Description,
		OwnerID:         params.OwnerId,
		CopiedFromWayID: nil,
		ProjectID:       nil,
		EstimationTime:  100,
		IsCompleted:     false,
		IsPrivate:       false,
	})
	if err != nil {
		return nil, err
	}

	// create metrics for new way recursively
	_ = lo.Map(training.TopicsTree, func(topicTree *pb.TopicTreeNode, _ int) *openapiGeneral.MwServerInternalSchemasMetricTreeNode {
		return wf.convertTopicTreeNode(ctx, topicTree, way.Uuid, nil)
	})

	newWay, err := wf.generalService.GetWayById(ctx, way.Uuid)
	if err != nil {
		return nil, err
	}

	return newWay, err
}

func (wf *WayFacade) CreateWay(ctx context.Context, payload *schemas.CreateWayPayload) (*openapiGeneral.MwServerInternalSchemasWayPlainResponse, error) {
	return wf.generalService.CreateWay(ctx, payload)
}

func (wf *WayFacade) UpdateWay(ctx context.Context, params *services.UpdateWayParams) (*openapiGeneral.MwServerInternalSchemasWayPlainResponse, error) {
	return wf.generalService.UpdateWay(ctx, params)
}

func (wf *WayFacade) GetWayById(ctx context.Context, wayUUID string) (*openapiGeneral.MwServerInternalSchemasWayPopulatedResponse, error) {
	return wf.generalService.GetWayById(ctx, wayUUID)
}

func (wf *WayFacade) GetAllWays(ctx context.Context, params *services.GetAllWaysParams) (*openapiGeneral.MwServerInternalSchemasGetAllWaysResponse, error) {
	return wf.generalService.GetAllWays(ctx, params)
}

func (wf *WayFacade) DeleteWayById(ctx *gin.Context, wayID string) error {
	return wf.generalService.DeleteWayById(ctx, wayID)
}

func (wf *WayFacade) GetWayStatisticsById(ctx context.Context, wayUUID string) (*openapiGeneral.MwServerInternalSchemasWayStatisticsTriplePeriod, error) {
	return wf.generalService.GetWayStatisticsById(ctx, wayUUID)
}
