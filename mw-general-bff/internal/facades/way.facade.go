package facades

import (
	"context"
	openapiGeneral "mw-general-bff/apiAutogenerated/general"
	"mw-general-bff/internal/schemas"
	"mw-general-bff/internal/services"
	pb "mw-general-bff/pkg/grpcAutoGenerated/training"

	"github.com/gin-gonic/gin"
	"github.com/samber/lo"
)

type WayFacade struct {
	generalService  *services.GeneralService
	trainingService *services.TrainingService
}

func newWayFacade(generalService *services.GeneralService, trainingService *services.TrainingService) *WayFacade {
	return &WayFacade{generalService, trainingService}
}

type CreateWayFromTrainingParams struct {
	OwnerId    string
	TrainingId string
}

func (wf *WayFacade) CreateWayFromTraining(ctx context.Context, params *CreateWayFromTrainingParams) (*openapiGeneral.MwServerInternalSchemasWayPlainResponse, error) {
	training, err := wf.trainingService.GetTrainingById(ctx, params.TrainingId)
	if err != nil {
		return nil, err
	}

	way, err := wf.generalService.CreateWay(ctx, &schemas.CreateWayPayload{
		Name:            training.Name,
		GoalDescription: training.Description,
		OwnerID:         params.OwnerId,
		CopiedFromWayID: nil,
		ProjectID:       nil,
		EstimationTime:  100,
		IsCompleted:     false,
		IsPrivate:       false,
	})
	if err != nil {
		return nil, err
	}

	// TODO add logic to create metrics for way from training topics after adding tree structure to topic response
	lo.ForEach(training.Topics, func(topic *pb.TopicPreview, _ int) {
		_, err = wf.generalService.CreateMetric(ctx, &schemas.CreateMetricPayload{
			Description:      topic.Name,
			WayUuid:          way.Uuid,
			IsDone:           false,
			MetricEstimation: 100,
			DoneDate:         nil,
			ParentUuid:       nil,
		})
	})
	return way, err
}

func (wf *WayFacade) CreateWay(ctx context.Context, payload *schemas.CreateWayPayload) (*openapiGeneral.MwServerInternalSchemasWayPlainResponse, error) {
	return wf.generalService.CreateWay(ctx, payload)
}

func (wf *WayFacade) UpdateWay(ctx context.Context, params *services.UpdateWayParams) (*openapiGeneral.MwServerInternalSchemasWayPlainResponse, error) {
	return wf.generalService.UpdateWay(ctx, params)
}

func (wf *WayFacade) GetWayById(ctx context.Context, wayUUID string) (*openapiGeneral.MwServerInternalSchemasWayPopulatedResponse, error) {
	return wf.generalService.GetWayById(ctx, wayUUID)
}

func (wf *WayFacade) GetAllWays(ctx context.Context, params *services.GetAllWaysParams) (*openapiGeneral.MwServerInternalSchemasGetAllWaysResponse, error) {
	return wf.generalService.GetAllWays(ctx, params)
}

func (wf *WayFacade) DeleteWayById(ctx *gin.Context, wayID string) error {
	return wf.generalService.DeleteWayById(ctx, wayID)
}

func (wf *WayFacade) GetWayStatisticsById(ctx context.Context, wayUUID string) (*openapiGeneral.MwServerInternalSchemasWayStatisticsTriplePeriod, error) {
	return wf.generalService.GetWayStatisticsById(ctx, wayUUID)
}
