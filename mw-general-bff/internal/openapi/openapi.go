package openapi

import (
	openapiGeneral "mw-general-bff/apiAutogenerated/general"
	openapiChat "mw-general-bff/apiAutogenerated/mw-chat"
	openapiChatWebSocket "mw-general-bff/apiAutogenerated/mw-chat-websocket"
	openapiGeneralBFF "mw-general-bff/apiAutogenerated/mw-general-bff"
	openapiMail "mw-general-bff/apiAutogenerated/mw-mail"
	openapiStorage "mw-general-bff/apiAutogenerated/mw-storage"
	"mw-general-bff/internal/auth"
	"mw-general-bff/internal/config"
	"net/http"
)

type authTransport struct {
	rt http.RoundTripper
}

func (t *authTransport) RoundTrip(req *http.Request) (*http.Response, error) {
	ctx := req.Context()
	if token, ok := ctx.Value(auth.ContextKeyAuthorization).(string); ok {
		req.Header.Set(auth.HeaderKeyAuthorization, token)
	}
	return t.rt.RoundTrip(req)
}

func MakeGeneralAPIClient(cfg *config.Config) *openapiGeneral.APIClient {
	generalAPIConfig := &openapiGeneral.Configuration{
		Host:   cfg.GeneralAPIHost,
		Scheme: "http",
		Servers: openapiGeneral.ServerConfigurations{
			{
				URL:         cfg.GeneralBaseURL,
				Description: "mw-general",
			},
		},
		HTTPClient: &http.Client{
			Transport: &authTransport{rt: http.DefaultTransport},
		},
	}
	return openapiGeneral.NewAPIClient(generalAPIConfig)
}

func MakeGeneralBFFAPIClient(cfg *config.Config) *openapiGeneralBFF.APIClient {
	chatBFFAPIConfig := &openapiGeneralBFF.Configuration{
		Host:   cfg.TestGeneralBffAPIHost,
		Scheme: "http",
		Servers: openapiGeneralBFF.ServerConfigurations{
			{
				URL:         cfg.TestGeneralBffAPIBaseUrl,
				Description: "mw-general-bff",
			},
		},
		HTTPClient: &http.Client{
			Transport: &authTransport{rt: http.DefaultTransport},
		},
	}
	return openapiGeneralBFF.NewAPIClient(chatBFFAPIConfig)
}

func MakeStorageAPIClient(cfg *config.Config) *openapiStorage.APIClient {
	storageAPIConfig := &openapiStorage.Configuration{
		Host:   cfg.StorageAPIHost,
		Scheme: "http",
		Servers: openapiStorage.ServerConfigurations{
			{
				URL:         cfg.StorageBaseURL,
				Description: "mw-storage",
			},
		},
		HTTPClient: &http.Client{
			Transport: &authTransport{rt: http.DefaultTransport},
		},
	}
	return openapiStorage.NewAPIClient(storageAPIConfig)
}

func MakeMailAPIClient(cfg *config.Config) *openapiMail.APIClient {
	mailAPIConfig := &openapiMail.Configuration{
		Host:   cfg.MailAPIHost,
		Scheme: "http",
		Servers: openapiMail.ServerConfigurations{
			{
				URL:         cfg.MailBaseURL,
				Description: "mw-mail",
			},
		},
		HTTPClient: &http.Client{
			Transport: &authTransport{rt: http.DefaultTransport},
		},
	}
	return openapiMail.NewAPIClient(mailAPIConfig)
}

func MakeChatAPIClient(cfg *config.Config) *openapiChat.APIClient {
	chatAPIConfig := &openapiChat.Configuration{
		Host:   cfg.ChatAPIHost,
		Scheme: "http",
		Servers: openapiChat.ServerConfigurations{
			{
				URL:         cfg.ChatBaseURL,
				Description: "mw-chat",
			},
		},
		HTTPClient: &http.Client{
			Transport: &authTransport{rt: http.DefaultTransport},
		},
	}
	return openapiChat.NewAPIClient(chatAPIConfig)
}

func MakeChatWebsocketAPIClient(cfg *config.Config) *openapiChatWebSocket.APIClient {
	chatAPIConfig := &openapiChatWebSocket.Configuration{
		Host:   cfg.ChatAPIWebsocketHost,
		Scheme: "http",
		Servers: openapiChatWebSocket.ServerConfigurations{
			{
				URL:         cfg.ChatWebsocketBaseURL,
				Description: "mw-chat-websocket",
			},
		},
		HTTPClient: &http.Client{
			Transport: &authTransport{rt: http.DefaultTransport},
		},
	}
	return openapiChatWebSocket.NewAPIClient(chatAPIConfig)
}
