package services

import (
	"context"
	"mw-training-bff/internal/schemas"

	pb "mw-training-bff/pkg/grpcAutoGenerated/training"

	"github.com/samber/lo"
)

type FavoriteUserTrainingService struct {
	notificationGRPC        pb.NotificationServiceClient
	notificationSettingGRPC pb.NotificationSettingServiceClient
}

func NewFavoriteUserTrainingService(
	notificationGRPC pb.NotificationServiceClient,
	notificationSettingGRPC pb.NotificationSettingServiceClient,
) *FavoriteUserTrainingService {
	return &FavoriteUserTrainingService{notificationGRPC, notificationSettingGRPC}
}

type GetNotificationListParams struct {
	UserUUID  string
	Page      int32
	Limit     int32
	IsOnlyNew bool
}

func (ns *NotificationService) GetNotificationList(ctx context.Context, params *GetNotificationListParams) (*schemas.GetNotificationListResponse, error) {
	notificationListRaw, err := ns.notificationGRPC.GetNotificationList(ctx, &pb.GetNotificationListRequest{
		UserUuid:  params.UserUUID,
		Page:      params.Page,
		Limit:     params.Limit,
		IsOnlyNew: params.IsOnlyNew,
	})
	if err != nil {
		return nil, err
	}

	notificationList := lo.Map(notificationListRaw.Notifications, func(notificationRaw *pb.Notification, i int) schemas.NotificationResponse {
		return schemas.NotificationResponse{
			UUID:        notificationRaw.Uuid,
			UserUUID:    notificationRaw.UserUuid,
			IsRead:      notificationRaw.IsRead,
			Description: notificationRaw.Description,
			Url:         notificationRaw.Url,
			Nature:      notificationRaw.Nature.String(),
			CreatedAt:   notificationRaw.CreatedAt,
		}
	})

	return &schemas.GetNotificationListResponse{
		TotalSize:     int(notificationListRaw.TotalSize),
		UnreadSize:    int(notificationListRaw.UnreadSize),
		Notifications: notificationList,
	}, nil
}

func (ns *NotificationService) UpdateNotification(ctx context.Context, notificationUUID string, isRead bool) (*schemas.NotificationResponse, error) {
	notification, err := ns.notificationGRPC.UpdateNotification(ctx, &pb.UpdateNotificationRequest{
		NotificationUuid: notificationUUID,
		IsRead:           isRead,
	})
	if err != nil {
		return nil, err
	}

	return &schemas.NotificationResponse{
		UUID:        notification.Uuid,
		UserUUID:    notification.UserUuid,
		IsRead:      notification.IsRead,
		Description: notification.Description,
		Url:         notification.Url,
		Nature:      notification.Nature.String(),
		CreatedAt:   notification.CreatedAt,
	}, nil
}

func (ns *NotificationService) GetNotificationSettingList(ctx context.Context, userUUID string) (*schemas.GetNotificationSettingListResponse, error) {
	notificationSettingListRaw, err := ns.notificationSettingGRPC.GetNotificationSettingList(
		ctx,
		&pb.GetNotificationSettingListRequest{
			UserUuid: userUUID,
		},
	)
	if err != nil {
		return nil, err
	}

	notificationSettingList := lo.Map(notificationSettingListRaw.NotificationSettings, func(notificationSettingRaw *pb.NotificationSettingResponse, _ int) schemas.NotificationSettingResponse {
		return schemas.NotificationSettingResponse{
			UUID:      notificationSettingRaw.Uuid,
			UserUUID:  notificationSettingRaw.UserUuid,
			Nature:    notificationSettingRaw.Nature.String(),
			Channel:   notificationSettingRaw.Channel,
			IsEnabled: notificationSettingRaw.IsEnabled,
		}
	})

	return &schemas.GetNotificationSettingListResponse{
		NotificationSettings: notificationSettingList,
	}, nil
}

func (ns *NotificationService) UpdateNotificationSetting(ctx context.Context, notificationSettingID string, isEnabled bool) (*schemas.NotificationSettingResponse, error) {
	in := &pb.UpdateNotificationSettingRequest{
		NotificationSettingUuid: notificationSettingID,
		IsEnabled:               isEnabled,
	}
	notificationSetting, err := ns.notificationSettingGRPC.UpdateNotificationSetting(ctx, in)
	if err != nil {
		return nil, err
	}

	return &schemas.NotificationSettingResponse{
		UUID:      notificationSetting.Uuid,
		UserUUID:  notificationSetting.UserUuid,
		Nature:    notificationSetting.Nature.String(),
		Channel:   notificationSetting.Channel,
		IsEnabled: notificationSetting.IsEnabled,
	}, nil
}
