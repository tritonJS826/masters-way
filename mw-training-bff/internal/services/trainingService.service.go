package services

import (
	"context"
	"mw-training-bff/internal/schemas"

	"github.com/samber/lo"

	pb "mw-training-bff/pkg/grpcAutogenerated/training"
)

type TrainingService struct {
	trainingGRPC pb.TrainingServiceClient
	// notificationSettingGRPC pb.NotificationSettingServiceClient
}

func NewTrainingService(
	notificationGRPC pb.TrainingServiceClient,
	// notificationSettingGRPC pb.NotificationSettingServiceClient,
) *TrainingService {
	return &TrainingService{notificationGRPC}
}

type GetTrainingListParams struct {
	UserUUID     string
	Page         int
	Limit        int
	TrainingName string
}

func (ts *TrainingService) GetTrainingList(ctx context.Context, params *GetTrainingListParams) (*schemas.TrainingList, error) {
	trainingListRaw, err := ts.trainingGRPC.GetTrainingList(ctx, &pb.GetTrainingListRequest{
		UserUuid: params.UserUUID,
	})
	if err != nil {
		return &schemas.TrainingList{}, err
	}

	trainingsPreview := lo.Map(trainingListRaw.TrainingList, func(trainingGrpc *pb.Training, _ int) schemas.TrainingPreview {
		owner := schemas.User{
			Uuid:     trainingGrpc.GetOwner().Uuid,
			Name:     trainingGrpc.GetOwner().Name,
			ImageUrl: trainingGrpc.GetOwner().ImageUrl,
		}

		return schemas.TrainingPreview{
			Uuid:        trainingGrpc.GetUuid(),
			Name:        trainingGrpc.GetName(),
			Description: trainingGrpc.GetDescription(),
			IsPrivate:   trainingGrpc.GetIsPrivate(),
			Owner:       owner,
			CreatedAt:   trainingGrpc.GetCreatedAt(),
			UpdatedAt:   trainingGrpc.GetUpdatedAt(),
		}
	})

	return &schemas.TrainingList{
		Size:      trainingListRaw.Size,
		Trainings: trainingsPreview,
	}, nil
}

// func (ns *NotificationService) UpdateNotification(ctx context.Context, notificationUUID string, isRead bool) (*schemas.NotificationResponse, error) {
// 	notification, err := ns.notificationGRPC.UpdateNotification(ctx, &pb.UpdateNotificationRequest{
// 		NotificationUuid: notificationUUID,
// 		IsRead:           isRead,
// 	})
// 	if err != nil {
// 		return nil, err
// 	}

// 	return &schemas.NotificationResponse{
// 		UUID:        notification.Uuid,
// 		UserUUID:    notification.UserUuid,
// 		IsRead:      notification.IsRead,
// 		Description: notification.Description,
// 		Url:         notification.Url,
// 		Nature:      notification.Nature.String(),
// 		CreatedAt:   notification.CreatedAt,
// 	}, nil
// }

// func (ns *NotificationService) GetNotificationSettingList(ctx context.Context, userUUID string) (*schemas.GetNotificationSettingListResponse, error) {
// 	notificationSettingListRaw, err := ns.notificationSettingGRPC.GetNotificationSettingList(
// 		ctx,
// 		&pb.GetNotificationSettingListRequest{
// 			UserUuid: userUUID,
// 		},
// 	)
// 	if err != nil {
// 		return nil, err
// 	}

// 	notificationSettingList := lo.Map(notificationSettingListRaw.NotificationSettings, func(notificationSettingRaw *pb.NotificationSettingResponse, _ int) schemas.NotificationSettingResponse {
// 		return schemas.NotificationSettingResponse{
// 			UUID:      notificationSettingRaw.Uuid,
// 			UserUUID:  notificationSettingRaw.UserUuid,
// 			Nature:    notificationSettingRaw.Nature.String(),
// 			Channel:   notificationSettingRaw.Channel,
// 			IsEnabled: notificationSettingRaw.IsEnabled,
// 		}
// 	})

// 	return &schemas.GetNotificationSettingListResponse{
// 		NotificationSettings: notificationSettingList,
// 	}, nil
// }

// func (ns *NotificationService) UpdateNotificationSetting(ctx context.Context, notificationSettingID string, isEnabled bool) (*schemas.NotificationSettingResponse, error) {
// 	in := &pb.UpdateNotificationSettingRequest{
// 		NotificationSettingUuid: notificationSettingID,
// 		IsEnabled:               isEnabled,
// 	}
// 	notificationSetting, err := ns.notificationSettingGRPC.UpdateNotificationSetting(ctx, in)
// 	if err != nil {
// 		return nil, err
// 	}

// 	return &schemas.NotificationSettingResponse{
// 		UUID:      notificationSetting.Uuid,
// 		UserUUID:  notificationSetting.UserUuid,
// 		Nature:    notificationSetting.Nature.String(),
// 		Channel:   notificationSetting.Channel,
// 		IsEnabled: notificationSetting.IsEnabled,
// 	}, nil
// }
