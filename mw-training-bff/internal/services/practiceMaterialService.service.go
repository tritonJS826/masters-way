package services

import (
	"context"
	"mw-training-bff/internal/schemas"

	"mw-training-bff/pkg/grpcAutogenerated/training"
	pb "mw-training-bff/pkg/grpcAutogenerated/training"
)

type PracticeMaterialService struct {
	practiceMaterialGRPC pb.PracticeMaterialServiceClient
}

func NewPracticeMaterialService(
	practiceMaterialGRPC pb.PracticeMaterialServiceClient,
) *PracticeMaterialService {
	return &PracticeMaterialService{practiceMaterialGRPC}
}

type GetPracticeMaterialsByTopicIdParams struct {
	TopicId string
}

func (pms *PracticeMaterialService) GetPracticeMaterialsByTopicId(ctx context.Context, params *GetPracticeMaterialsByTopicIdParams) (*schemas.PracticeMaterials, error) {
	// notificationListRaw, err := pms.practiceMaterialGRPC.GetPracticeMaterialsByTopicId(ctx, &pb.GetNotificationListRequest{
	// 	UserUuid:  params.UserUUID,
	// 	Page:      params.Page,
	// 	Limit:     params.Limit,
	// 	IsOnlyNew: params.IsOnlyNew,
	// })
	// if err != nil {
	// 	return nil, err
	// }

	// notificationList := lo.Map(notificationListRaw.Notifications, func(notificationRaw *pb.Notification, i int) schemas.NotificationResponse {
	// 	return schemas.NotificationResponse{
	// 		UUID:        notificationRaw.Uuid,
	// 		UserUUID:    notificationRaw.UserUuid,
	// 		IsRead:      notificationRaw.IsRead,
	// 		Description: notificationRaw.Description,
	// 		Url:         notificationRaw.Url,
	// 		Nature:      notificationRaw.Nature.String(),
	// 		CreatedAt:   notificationRaw.CreatedAt,
	// 	}
	// })

	return &schemas.PracticeMaterials{
		Size:              10,
		PracticeMaterials: []schemas.PracticeMaterial{},
	}, nil
}

type CreatePracticeMaterialParams struct {
	TopicId      string
	Name         string
	Order        int32
	Description  string
	Answer       string
	PracticeType string
	TimeToAnswer int32
}

func (pms *PracticeMaterialService) CreatePracticeMaterial(ctx context.Context, params *CreatePracticeMaterialParams) (*schemas.PracticeMaterial, error) {
	practiceMaterial, err := pms.practiceMaterialGRPC.CreatePracticeMaterial(ctx, &pb.CreatePracticeMaterialRequest{
		TopicUuid:    params.TopicId,
		Name:         params.Name,
		Order:        params.Order,
		Description:  params.Description,
		Answer:       params.Answer,
		PracticeType: params.PracticeType,
		TimeToAnswer: params.TimeToAnswer,
	})

	if err != nil {
		return nil, err
	}

	return &schemas.PracticeMaterial{
		Uuid:                  practiceMaterial.Uuid,
		TopicUuid:             practiceMaterial.TopicUuid,
		Name:                  practiceMaterial.Name,
		TaskDescription:       practiceMaterial.Description,
		Answer:                practiceMaterial.Answer,
		PracticeType:          practiceMaterial.PracticeType,
		TimeToAnswer:          practiceMaterial.TimeToAnswer,
		PracticeMaterialOrder: practiceMaterial.Order,
		CreatedAt:             practiceMaterial.CreatedAt,
		UpdatedAt:             practiceMaterial.UpdatedAt,
	}, nil
}

type UpdatePracticeMaterialParams struct {
	PracticeMaterialId string
	Name               *string
	Order              *int32
	Description        *string
	Answer             *string
	PracticeType       *string
	TimeToAnswer       *int32
}

func (pms *PracticeMaterialService) UpdatePracticeMaterial(ctx context.Context, params *UpdatePracticeMaterialParams) (*schemas.PracticeMaterial, error) {
	practiceMaterial, err := pms.practiceMaterialGRPC.UpdatePracticeMaterial(ctx, &pb.UpdatePracticeMaterialRequest{
		Uuid:         params.PracticeMaterialId,
		Name:         params.Name,
		Description:  params.Description,
		Answer:       params.Answer,
		PracticeType: params.PracticeType,
		TimeToAnswer: params.TimeToAnswer,
	})

	return &schemas.PracticeMaterial{
		Uuid:                  practiceMaterial.Uuid,
		TopicUuid:             practiceMaterial.TopicUuid,
		Name:                  practiceMaterial.Name,
		TaskDescription:       practiceMaterial.Description,
		Answer:                practiceMaterial.Answer,
		PracticeType:          practiceMaterial.PracticeType,
		TimeToAnswer:          practiceMaterial.TimeToAnswer,
		CreatedAt:             practiceMaterial.CreatedAt,
		UpdatedAt:             practiceMaterial.UpdatedAt,
		PracticeMaterialOrder: practiceMaterial.Order,
	}, err
}

func (pms *PracticeMaterialService) DeletePracticeMaterial(ctx context.Context, practiceMaterialID string) error {
	deletePracticeMaterialRequest := &training.DeletePracticeMaterialRequest{
		MaterialUuid: practiceMaterialID,
	}

	_, err := pms.practiceMaterialGRPC.DeletePracticeMaterial(ctx, deletePracticeMaterialRequest)
	if err != nil {
		return err
	}

	return nil
}
