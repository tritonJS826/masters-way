package services

import (
	"context"
	"mw-training-bff/internal/schemas"

	"mw-training-bff/pkg/grpcAutogenerated/training"
	pb "mw-training-bff/pkg/grpcAutogenerated/training"
)

type TheoryMaterialService struct {
	theoryMaterialGRPC pb.TheoryMaterialServiceClient
}

func NewTheoryMaterialService(
	theoryMaterialGRPC pb.TheoryMaterialServiceClient,
) *TheoryMaterialService {
	return &TheoryMaterialService{theoryMaterialGRPC}
}

type GetTheoryMaterialsByTopicIdParams struct {
	TopicId string
}

func (tms *TheoryMaterialService) GetTheoryMaterialsByTopicId(ctx context.Context, params *GetTheoryMaterialsByTopicIdParams) (*schemas.TheoryMaterials, error) {
	// theoryMaterialsRaw, err := tms.theoryMaterialGRPC.GetTheoryMaterialsByTopicId(ctx, &pb.GetTh{
	// 	UserUuid:  params.UserUUID,
	// 	Page:      params.Page,
	// 	Limit:     params.Limit,
	// 	IsOnlyNew: params.IsOnlyNew,
	// })
	// if err != nil {
	// 	return nil, err
	// }

	return &schemas.TheoryMaterials{
		Size:            10,
		TheoryMaterials: []schemas.TheoryMaterial{},
	}, nil
}

type CreateTheoryMaterialParams struct {
	TopicId     string
	Name        string
	Description string
}

func (tms *TheoryMaterialService) CreateTheoryMaterial(ctx context.Context, params *CreateTheoryMaterialParams) (*schemas.TheoryMaterial, error) {
	theoryMaterial, err := tms.theoryMaterialGRPC.CreateTheoryMaterial(ctx, &pb.CreateTheoryMaterialRequest{
		TopicUuid:   params.TopicId,
		Name:        params.Name,
		Description: params.Description,
	})

	if err != nil {
		return nil, err
	}

	return &schemas.TheoryMaterial{
		Uuid:                theoryMaterial.Uuid,
		TopicUuid:           theoryMaterial.TopicUuid,
		Name:                theoryMaterial.Name,
		Description:         theoryMaterial.Description,
		CreatedAt:           theoryMaterial.CreatedAt,
		UpdatedAt:           theoryMaterial.UpdatedAt,
		TheoryMaterialOrder: theoryMaterial.Order,
	}, nil
}

type UpdateTheoryMaterialParams struct {
	TopicId     string
	Name        string
	Description string
}

func (tms *TheoryMaterialService) UpdateTheoryMaterial(ctx context.Context, params *UpdateTheoryMaterialParams) (*schemas.TheoryMaterial, error) {
	theoryMaterialRaw, err := tms.theoryMaterialGRPC.UpdateTheoryMaterial(ctx, &pb.UpdateTheoryMaterialRequest{
		Uuid:        params.TopicId,
		Name:        params.Name,
		Description: params.Description,
	},
	)
	if err != nil {
		return nil, err
	}

	return &schemas.TheoryMaterial{
		Uuid:      theoryMaterialRaw.Uuid,
		TopicUuid: theoryMaterialRaw.TopicUuid,
		Name:      theoryMaterialRaw.Name,
		// TheoryMaterialOrder: theoryMaterialRaw.Order,
		Description: theoryMaterialRaw.Description,
		CreatedAt:   theoryMaterialRaw.CreatedAt,
		UpdatedAt:   theoryMaterialRaw.UpdatedAt,
	}, nil
}

func (tms *TheoryMaterialService) DeleteTheoryMaterial(ctx context.Context, theoryMaterialID string) error {
	// in := &pb.UpdateNotificationSettingRequest{
	// 	NotificationSettingUuid: notificationSettingID,
	// 	IsEnabled:               isEnabled,
	// }
	// notificationSetting, err := pms.notificationSettingGRPC.UpdateNotificationSetting(ctx, in)
	// if err != nil {
	// 	return nil, err
	// }

	deleteTheoryMaterialRequest := &training.DeleteTheoryMaterialRequest{
		Uuid: theoryMaterialID,
	}

	_, err := tms.theoryMaterialGRPC.DeleteTheoryMaterial(ctx, deleteTheoryMaterialRequest)

	if err != nil {
		return err
	}

	return nil
}
