package services

import (
	"context"
	"mw-training-bff/internal/schemas"

	pb "mw-training-bff/pkg/grpcAutogenerated/training"
)

type TopicService struct {
	topicGRPC pb.TopicsServiceClient
}

func NewTopicService(
	topicGRPC pb.TopicsServiceClient,
) *TopicService {
	return &TopicService{topicGRPC}
}

type CreateTopicParams struct {
	Name            string
	TrainingUuid    string
	TopicOrder      int32
	ParentTopicUuid *string
}

func (ts *TopicService) CreateTopic(ctx context.Context, params *CreateTopicParams) (*schemas.Topic, error) {

	topic, err := ts.topicGRPC.CreateTopic(ctx, &pb.CreateTopicRequest{
		Name:            params.Name,
		TrainingUuid:    params.TrainingUuid,
		TopicOrder:      params.TopicOrder,
		ParentTopicUuid: params.ParentTopicUuid,
	})
	if err != nil {
		return nil, err
	}

	return &schemas.Topic{
		Uuid:         topic.Uuid,
		Name:         topic.Name,
		TrainingUuid: topic.TrainingUuid,
		TopicOrder:   topic.TopicOrder,
	}, nil
}

type UpdateTopicParams struct {
	Name      string
	TopicUuid string
}

func (ts *TopicService) UpdateTopic(ctx context.Context, params *UpdateTopicParams) (*schemas.Topic, error) {
	topic, err := ts.topicGRPC.UpdateTopic(ctx, &pb.UpdateTopicRequest{
		Uuid: params.TopicUuid,
		Name: params.Name,
	})
	if err != nil {
		return nil, err
	}

	return &schemas.Topic{
		Uuid:         topic.Uuid,
		Name:         topic.Name,
		TrainingUuid: topic.TrainingUuid,
		TopicOrder:   topic.TopicOrder,
		ParentUuid:   topic.ParentTopicUuid,
		CreatedAt:    topic.CreatedAt,
	}, nil
}

type DeleteTopicParams struct {
	TopicUuid string
}

func (ts *TopicService) DeleteTopic(ctx context.Context, params *DeleteTopicParams) error {
	in := &pb.DeleteTopicRequest{
		TopicUuid: params.TopicUuid,
	}
	_, err := ts.topicGRPC.DeleteTopic(ctx, in)
	if err != nil {
		return err
	}

	return nil
}
