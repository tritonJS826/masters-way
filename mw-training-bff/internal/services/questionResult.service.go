package services

import (
	"context"
	openapiGeneral "mw-training-bff/apiAutogenerated/general"

	pb "mw-training-bff/pkg/grpcAutogenerated/training"
)

// service QuestionResultsService {
//   rpc CreateQuestionResult(CreateQuestionResultRequest) returns (QuestionResult);
//   rpc GetQuestionResultsBySessionUuid(GetQuestionResultsBySessionUuidRequest) returns (GetQuestionResultsBySessionUuidResponse);
// }

type QuestionResultService struct {
	questionResultGRPC pb.QuestionResultsServiceClient
	generalAPI         *openapiGeneral.APIClient
}

func NewQuestionResultService(
	questionResultGRPC pb.QuestionResultsServiceClient,
	generalAPI *openapiGeneral.APIClient,
) *QuestionResultService {
	return &QuestionResultService{questionResultGRPC, generalAPI}
}

type CreateQuestionResultParams struct {
	SessionUuid       string
	QuestionUuid      string
	UserUuid          string
	TestUuid          string
	ResultDescription string
	IsCorrect         bool
}

func (s *QuestionResultService) CreateQuestionResult(ctx context.Context, params *CreateQuestionResultParams) (*pb.QuestionResult, error) {
	questionResult, err := s.questionResultGRPC.CreateQuestionResult(ctx, &pb.CreateQuestionResultRequest{
		QuestionUuid:      params.QuestionUuid,
		UserUuid:          params.UserUuid,
		TestUuid:          params.TestUuid,
		TestSessionUuid:   params.SessionUuid,
		IsOk:              params.IsCorrect,
		ResultDescription: params.ResultDescription,
	})
	if err != nil {
		return nil, err
	}

	return &pb.QuestionResult{
		Uuid:              questionResult.Uuid,
		QuestionUuid:      questionResult.QuestionUuid,
		UserUuid:          questionResult.UserUuid,
		TestUuid:          questionResult.TestUuid,
		TestSessionUuid:   questionResult.TestSessionUuid,
		IsOk:              questionResult.IsOk,
		ResultDescription: questionResult.ResultDescription,
		CreatedAt:         questionResult.CreatedAt,
	}, nil
}

type GetQuestionResultsBySessionUuidParams struct {
	SessionUuid string
	UserUuid    string
}

func (s *QuestionResultService) GetQuestionResultsBySessionUuid(ctx context.Context, params *GetQuestionResultsBySessionUuidParams) ([]*pb.QuestionResult, error) {
	results, err := s.questionResultGRPC.GetQuestionResultsBySessionUuid(ctx, &pb.GetQuestionResultsBySessionUuidRequest{
		SessionUuid: params.SessionUuid,
		UserUuid:    params.UserUuid,
	})
	if err != nil {
		return nil, err
	}

	questionResults := make([]*pb.QuestionResult, len(results.Results))
	for i, result := range results.Results {
		questionResults[i] = &pb.QuestionResult{
			Uuid:              result.Uuid,
			QuestionUuid:      result.QuestionUuid,
			UserUuid:          result.UserUuid,
			TestUuid:          result.TestUuid,
			TestSessionUuid:   result.TestSessionUuid,
			IsOk:              result.IsOk,
			ResultDescription: result.ResultDescription,
			CreatedAt:         result.CreatedAt,
		}
	}

	return questionResults, nil
}
