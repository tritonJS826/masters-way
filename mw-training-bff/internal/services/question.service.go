package services

import (
	"context"
	openapiGeneral "mw-training-bff/apiAutogenerated/general"
	"mw-training-bff/internal/schemas"

	pb "mw-training-bff/pkg/grpcAutogenerated/training"
)

// service QuestionService {
//   rpc CreateQuestion(CreateQuestionRequest) returns (Question);
//   rpc UpdateQuestion(UpdateQuestionRequest) returns (Question);
//   rpc DeleteQuestion(DeleteQuestionRequest) returns (google.protobuf.Empty);
// }

type QuestionService struct {
	questionGRPC pb.QuestionServiceClient
	generalAPI   *openapiGeneral.APIClient
}

func NewQuestionService(
	questionGRPC pb.QuestionServiceClient,
	generalAPI *openapiGeneral.APIClient,
) *QuestionService {
	return &QuestionService{questionGRPC, generalAPI}
}

type CreateQuestionParams struct {
	TestUuid     string
	UserUuid     string
	Name         string
	QuestionText *string
	TimeToAnswer *int32
	Answer       *string
	PracticeType string
}

func (ts *QuestionService) CreateQuestion(ctx context.Context, params *CreateQuestionParams) (*schemas.Question, error) {
	question, err := ts.questionGRPC.CreateQuestion(ctx, &pb.CreateQuestionRequest{
		TestUuid:     params.TestUuid,
		UserUuid:     params.UserUuid,
		Name:         params.Name,
		QuestionText: params.QuestionText,
		TimeToAnswer: params.TimeToAnswer,
		Answer:       params.Answer,
		PracticeType: params.PracticeType,
	})
	if err != nil {
		return nil, err
	}

	return &schemas.Question{
		UUID:         question.Uuid,
		TestUUID:     question.TestUuid,
		QuestionText: question.QuestionText,
		Order:        question.Order,
		TimeToAnswer: question.TimeToAnswer,
		Answer:       question.Answer,
		IsActive:     question.IsActive,
		CreatedAt:    question.CreatedAt,
		UpdatedAt:    question.UpdatedAt,
	}, nil
}

type UpdateQuestionParams struct {
	QuestionUUID string
	UserUUID     string
	Name         *string
	QuestionText *string
	TimeToAnswer *int32
	Answer       *string
	PracticeType *string
	Order        *int32
}

func (ts *QuestionService) UpdateQuestion(ctx context.Context, params *UpdateQuestionParams) (*schemas.Question, error) {
	question, err := ts.questionGRPC.UpdateQuestion(ctx, &pb.UpdateQuestionRequest{
		QuestionUuid: params.QuestionUUID,
		UserUuid:     params.UserUUID,
		Name:         params.Name,
		QuestionText: params.QuestionText,
		TimeToAnswer: params.TimeToAnswer,
		Answer:       params.Answer,
		PracticeType: params.PracticeType,
		Order:        params.Order,
	})
	if err != nil {
		return nil, err
	}

	return &schemas.Question{
		UUID:         question.Uuid,
		TestUUID:     question.TestUuid,
		QuestionText: question.QuestionText,
		Order:        question.Order,
		TimeToAnswer: question.TimeToAnswer,
		Answer:       question.Answer,
		IsActive:     question.IsActive,
		CreatedAt:    question.CreatedAt,
		UpdatedAt:    question.UpdatedAt,
	}, nil
}

type DeleteQuestionParams struct {
	UserUuid     string
	QuestionUuid string
}

func (ts *QuestionService) DeleteQuestion(ctx context.Context, params *DeleteQuestionParams) error {
	in := &pb.DeleteQuestionRequest{
		UserUuid:     params.UserUuid,
		QuestionUuid: params.QuestionUuid}
	_, err := ts.questionGRPC.DeleteQuestion(ctx, in)
	if err != nil {
		return err
	}

	return nil
}
