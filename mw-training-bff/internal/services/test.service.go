package services

// service TestService {
//   rpc GetTestList(GetTestListRequest) returns (TestPreviewList);
//   rpc GetTestsByUserId(GetTestsByUserIdRequest) returns (TestPreviewList);
//   rpc CreateTest(CreateTestRequest) returns (Test);
//   rpc GetTestById(GetTestByIdRequest) returns (Test);
//   rpc UpdateTest(UpdateTestRequest) returns (Test);
//   rpc DeleteTest(DeleteTestRequest) returns (google.protobuf.Empty);
// }

import (
	"context"
	"mw-training-bff/internal/schemas"
	pb "mw-training-bff/pkg/grpcAutogenerated/training"
)

type TestService struct {
	testGRPC pb.TestServiceClient
}

func NewTestService(
	testGRPC pb.TestServiceClient,
) *TestService {
	return &TestService{testGRPC}
}

type CreateTestParams struct {
	Name        string
	Description *string
	UserUuid    string
	IsPrivate   bool
}

func (s *TestService) CreateTest(ctx context.Context, params *CreateTestParams) (*schemas.Test, error) {
	test, err := s.testGRPC.CreateTest(ctx, &pb.CreateTestRequest{
		Name:        params.Name,
		Description: *params.Description,
		OwnerUuid:   params.UserUuid,
		IsPrivate:   params.IsPrivate,
	})
	if err != nil {
		return nil, err
	}

	return &schemas.Test{
		UUID:        test.Uuid,
		Name:        test.Name,
		Description: test.Description,
		CreatedAt:   test.CreatedAt,
		UpdatedAt:   test.UpdatedAt,
		OwnerUUID:   test.OwnerUuid,
		IsPrivate:   test.IsPrivate,
		Questions:   make([]*schemas.Question, 0),
	}, nil
}

type UpdateTestParams struct {
	TestUuid    string
	UserUuid    string
	Name        *string
	Description *string
	IsPrivate   *bool
}

func (s *TestService) UpdateTest(ctx context.Context, params *UpdateTestParams) (*schemas.TestPreview, error) {
	test, err := s.testGRPC.UpdateTest(ctx, &pb.UpdateTestRequest{
		UserUuid:    params.UserUuid,
		TestUuid:    params.TestUuid,
		Name:        params.Name,
		Description: params.Description,
		IsPrivate:   params.IsPrivate,
	})
	if err != nil {
		return nil, err
	}

	return &schemas.TestPreview{
		UUID:        test.Uuid,
		Name:        test.Name,
		Description: test.Description,
		CreatedAt:   test.CreatedAt,
		UpdatedAt:   test.UpdatedAt,
		OwnerUUID:   test.OwnerUuid,
	}, nil
}

type DeleteTestParams struct {
	TestUuid string
	UserUuid string
}

func (s *TestService) DeleteTest(ctx context.Context, params *DeleteTestParams) error {
	_, err := s.testGRPC.DeleteTest(ctx, &pb.DeleteTestRequest{
		TestUuid:  params.TestUuid,
		OwnerUuid: params.UserUuid,
	})
	if err != nil {
		return err
	}

	return nil
}

type GetTestListParams struct {
	PartialName string
	Page        int32
	Limit       int32
}

func (s *TestService) GetTestList(ctx context.Context, params *GetTestListParams) (*schemas.TestPreviewList, error) {
	tests, err := s.testGRPC.GetTestList(ctx, &pb.GetTestListRequest{
		Name:  params.PartialName,
		Page:  params.Page,
		Limit: params.Limit,
	})
	if err != nil {
		return nil, err
	}

	testList := make([]*schemas.TestPreview, len(tests.TestsList))
	for i, test := range tests.TestsList {
		testList[i] = &schemas.TestPreview{
			UUID:        test.Uuid,
			Name:        test.Name,
			Description: test.Description,
			OwnerUUID:   test.OwnerUuid,
			UpdatedAt:   test.UpdatedAt,
			CreatedAt:   test.CreatedAt,
		}
	}

	return &schemas.TestPreviewList{
		Size:      tests.Size,
		TestsList: testList,
	}, nil
}

type GetTestsAmountByUserIdParams struct {
	UserUuid string
}

func (s *TestService) GetTestsAmountByUserId(ctx context.Context, params *GetTestsAmountByUserIdParams) (*schemas.TestsAmount, error) {
	amount, err := s.testGRPC.GetTestAmountByUserId(ctx, &pb.GetTestsAmountByUserIdRequest{
		UserUuid: params.UserUuid,
	})
	if err != nil {
		return nil, err
	}
	return &schemas.TestsAmount{
		Own:       amount.Own,
		Completed: amount.Completed,
	}, nil
}

type GetTestsByUserIdParams struct {
	OwnerUuid string
	UserUuid  *string
}

func (s *TestService) GetTestsByUserId(ctx context.Context, params *GetTestsByUserIdParams) (*schemas.TestPreviewList, error) {
	tests, err := s.testGRPC.GetTestsByUserId(ctx, &pb.GetTestsByUserIdRequest{
		OwnerUuid: params.OwnerUuid,
		UserUuid:  params.UserUuid,
	})
	if err != nil {
		return nil, err
	}

	testList := make([]*schemas.TestPreview, len(tests.TestsList))
	for i, test := range tests.TestsList {
		testList[i] = &schemas.TestPreview{
			UUID:        test.Uuid,
			Name:        test.Name,
			Description: test.Description,
			OwnerUUID:   test.OwnerUuid,
			UpdatedAt:   test.UpdatedAt,
			CreatedAt:   test.CreatedAt,
		}
	}

	return &schemas.TestPreviewList{
		Size:      tests.Size,
		TestsList: testList,
	}, nil
}

type GetTestByIdParams struct {
	Uuid             string
	RequestOwnerUuid string
}

func (s *TestService) GetTestById(ctx context.Context, params *GetTestByIdParams) (*schemas.Test, error) {
	test, err := s.testGRPC.GetTestById(ctx, &pb.GetTestByIdRequest{
		Uuid:      params.Uuid,
		OwnerUuid: params.RequestOwnerUuid,
	})
	if err != nil {
		return nil, err
	}

	questions := make([]*schemas.Question, len(test.Questions))
	for i, question := range test.Questions {
		questions[i] = &schemas.Question{
			UUID:         question.Uuid,
			Name:         &question.Name,
			TestUUID:     question.TestUuid,
			QuestionText: question.QuestionText,
			Order:        question.Order,
			TimeToAnswer: question.TimeToAnswer,
			Answer:       question.Answer,
			IsActive:     question.IsActive,
			CreatedAt:    question.CreatedAt,
			UpdatedAt:    question.UpdatedAt,
		}
	}

	return &schemas.Test{
		UUID:        test.Uuid,
		Name:        test.Name,
		Description: test.Description,
		OwnerUUID:   test.OwnerUuid,
		IsPrivate:   test.IsPrivate,
		UpdatedAt:   test.UpdatedAt,
		CreatedAt:   test.CreatedAt,
		Questions:   questions,
	}, nil
}
